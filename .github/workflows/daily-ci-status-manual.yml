name: Manual - Daily CI Status

on:
  workflow_dispatch:
    inputs:
      sr_th:
        description: 'Success rate threshold (%)'
        required: false
        default: '85'
      p95_th:
        description: 'p95 duration threshold (minutes)'
        required: false
        default: '6'
      assignees:
        description: 'Comma-separated GitHub usernames to assign CI alerts'
        required: false
        default: ''
      team_mention:
        description: 'Team or user mention to include in alert body (e.g. @org/team)'
        required: false
        default: ''

permissions:
  contents: read
  issues: write

jobs:
  daily-status-manual:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup gh and jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          gh --version || true
      - name: Generate status report
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          # Repo config defaults
          if [ -f .github/ci/config.json ]; then
            CFG_ASSIGNEES=$(jq -r '.alerts.assignees // empty' .github/ci/config.json || echo '')
            CFG_TEAM=$(jq -r '.alerts.team_mention // empty' .github/ci/config.json || echo '')
            if [ -n "$CFG_ASSIGNEES" ] && [ -z "${ALERT_ASSIGNEES:-}" ]; then export ALERT_ASSIGNEES="$CFG_ASSIGNEES"; fi
            if [ -n "$CFG_TEAM" ] && [ -z "${ALERT_TEAM_MENTION:-}" ]; then export ALERT_TEAM_MENTION="$CFG_TEAM"; fi
            CFG_SR_DEF=$(jq -r '.thresholds.default.sr_th // empty' .github/ci/config.json || echo '')
            CFG_P95_DEF=$(jq -r '.thresholds.default.p95_th // empty' .github/ci/config.json || echo '')
            if [ -n "$CFG_SR_DEF" ] && [ -z "${SR_TH:-}" ]; then export SR_TH="$CFG_SR_DEF"; fi
            if [ -n "$CFG_P95_DEF" ] && [ -z "${P95_TH:-}" ]; then export P95_TH="$CFG_P95_DEF"; fi
            RECOVERY_DAYS=$(jq -r '.alerts.recovery_days // 3' .github/ci/config.json || echo '3')
          else
            RECOVERY_DAYS=3
          fi
          # Inputs
          SR_TH_IN='${{ github.event.inputs.sr_th }}'
          P95_TH_IN='${{ github.event.inputs.p95_th }}'
          ASSIGNEES_IN='${{ github.event.inputs.assignees }}'
          TEAM_MENTION_IN='${{ github.event.inputs.team_mention }}'
          if [ -n "$SR_TH_IN" ]; then export SR_TH="$SR_TH_IN"; fi
          if [ -n "$P95_TH_IN" ]; then export P95_TH="$P95_TH_IN"; fi
          if [ -n "$ASSIGNEES_IN" ]; then export ALERT_ASSIGNEES="$ASSIGNEES_IN"; fi
          if [ -n "$TEAM_MENTION_IN" ]; then export ALERT_TEAM_MENTION="$TEAM_MENTION_IN"; fi

          : > CI_DAILY_STATUS.md
          echo "# Daily CI Status Snapshot" >> CI_DAILY_STATUS.md
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> CI_DAILY_STATUS.md
          echo "" >> CI_DAILY_STATUS.md
          echo "Baseline: ci-baseline-2025-09-21 (for comparison in case of regressions)" >> CI_DAILY_STATUS.md
          echo "" >> CI_DAILY_STATUS.md

          echo "## Core Strict - Build and Tests (last 3)" >> CI_DAILY_STATUS.md
          bash scripts/monitor_ci_runs.sh --workflow "Core Strict - Build and Tests" --count 3 --interval 10 --max-iterations 1 >> CI_DAILY_STATUS.md || true
          echo "" >> CI_DAILY_STATUS.md

          echo "## Core Strict - Exports, Validation, Comparison (last 3)" >> CI_DAILY_STATUS.md
          bash scripts/monitor_ci_runs.sh --workflow "Core Strict - Exports, Validation, Comparison" --count 3 --interval 10 --max-iterations 1 >> CI_DAILY_STATUS.md || true
          echo "" >> CI_DAILY_STATUS.md

          echo "## Quick Check - Verification + Lint (last 3)" >> CI_DAILY_STATUS.md
          bash scripts/monitor_ci_runs.sh --workflow "Quick Check - Verification + Lint" --count 3 --interval 10 --max-iterations 1 >> CI_DAILY_STATUS.md || true
          echo "" >> CI_DAILY_STATUS.md

          echo "### 7-Day Trend" >> CI_DAILY_STATUS.md
          echo "| Workflow | Runs | Success% | p50 | p95 | Avg |" >> CI_DAILY_STATUS.md
          echo "|----------|------|----------|-----|-----|-----|" >> CI_DAILY_STATUS.md
          for workflow in "Core Strict - Build and Tests" "Core Strict - Exports, Validation, Comparison" "Quick Check - Verification + Lint"; do
            bash scripts/ci_trend_summary.sh --workflow "$workflow" --days 7 --markdown >> CI_DAILY_STATUS.md || echo "| $workflow | N/A | N/A | N/A | N/A | N/A |" >> CI_DAILY_STATUS.md
          done
          echo "" >> CI_DAILY_STATUS.md

          # vcpkg cache hit rate (latest strict exports)
          echo "### vcpkg Cache Metrics (latest strict exports)" >> CI_DAILY_STATUS.md
          RUN_ID=$(gh run list --workflow "Core Strict - Exports, Validation, Comparison" --limit 1 --json databaseId 2>/dev/null | jq -r '.[0].databaseId // empty')
          if [ -n "$RUN_ID" ]; then
            mkdir -p _tmp_art
            gh run download "$RUN_ID" -n "strict-exports-reports-Linux" -D _tmp_art >/dev/null 2>&1 || \
            gh run download "$RUN_ID" -n "strict-exports-reports-Ubuntu" -D _tmp_art >/dev/null 2>&1 || \
            gh run download "$RUN_ID" -n "strict-exports-reports-ubuntu-latest" -D _tmp_art >/dev/null 2>&1 || true
            STATS_FILE=""
            if [ -f "_tmp_art/build/vcpkg_cache_stats.json" ]; then STATS_FILE="_tmp_art/build/vcpkg_cache_stats.json"; fi
            if [ -z "$STATS_FILE" ] && [ -f "_tmp_art/vcpkg_cache_stats.json" ]; then STATS_FILE="_tmp_art/vcpkg_cache_stats.json"; fi
            if [ -n "$STATS_FILE" ]; then
              if jq -e . "$STATS_FILE" >/dev/null 2>&1; then
                CACHEABLE=$(jq -r '.cacheable // true' "$STATS_FILE")
                HIT=$(jq -r '.hit_rate // "N/A"' "$STATS_FILE")
                INST=$(jq -r '.installing // "N/A"' "$STATS_FILE")
                REST=$(jq -r '.restored // "N/A"' "$STATS_FILE")
                TOTAL=$(jq -r '.total // .total_signals // "N/A"' "$STATS_FILE")
                if [ "$CACHEABLE" = "false" ] || [ "$TOTAL" = "0" ]; then
                  echo "- Cache Hit Rate: N/A (header-only or no compiled ports)" >> CI_DAILY_STATUS.md
                else
                  echo "- Cache Hit Rate: ${HIT}% (restored=${REST}, installing=${INST}, total=${TOTAL})" >> CI_DAILY_STATUS.md
                fi
              else
                echo "- Cache metrics JSON invalid (parsing error)" >> CI_DAILY_STATUS.md
              fi
            else
              echo "- Cache metrics not available" >> CI_DAILY_STATUS.md
            fi
            rm -rf _tmp_art
          else
            echo "- No recent strict exports run found" >> CI_DAILY_STATUS.md
          fi

          echo "" >> CI_DAILY_STATUS.md
          echo "### Alerts (last 7 days)" >> CI_DAILY_STATUS.md
          SR_TH=${SR_TH:-85}
          P95_TH=${P95_TH:-6}
          ALERTS=()
          for WF in "Core Strict - Build and Tests" "Core Strict - Exports, Validation, Comparison" "Quick Check - Verification + Lint"; do
            SR_EFF="$SR_TH"; P95_EFF="$P95_TH"
            if [ -f .github/ci/config.json ]; then
              SR_CFG=$(jq -r --arg wf "$WF" '.thresholds.per_workflow[$wf].sr_th // empty' .github/ci/config.json || echo '')
              P95_CFG=$(jq -r --arg wf "$WF" '.thresholds.per_workflow[$wf].p95_th // empty' .github/ci/config.json || echo '')
              if [ -n "$SR_CFG" ]; then SR_EFF="$SR_CFG"; fi
              if [ -n "$P95_CFG" ]; then P95_EFF="$P95_CFG"; fi
            fi
            TREND_JSON=$(bash scripts/ci_trend_summary.sh --workflow "$WF" --days 7 --json || echo '{}')
            SR=$(echo "$TREND_JSON" | jq -r '.success_rate // empty' | sed 's/%//')
            P95=$(echo "$TREND_JSON" | jq -r '.duration_p95_min // empty' | sed 's/[^0-9]//g')
            if [ -n "$SR" ] && [ -n "$P95" ]; then
              SR_OK=$(awk -v a="$SR" -v b="$SR_EFF" 'BEGIN{print (a+0)>=b?"1":"0"}')
              P95_OK=$(awk -v a="$P95" -v b="$P95_EFF" 'BEGIN{print (a+0)<=b?"1":"0"}')
              if [ "$SR_OK" = "0" ] || [ "$P95_OK" = "0" ]; then
                ALERTS+=("- [!] $WF â€” success=${SR}% p95=${P95}m (thresholds: success>=${SR_EFF}%, p95<=${P95_EFF}m)")
              fi
            fi
          done
          if [ ${#ALERTS[@]} -gt 0 ]; then
            for a in "${ALERTS[@]}"; do echo "$a" >> CI_DAILY_STATUS.md; done
          else
            echo "- None" >> CI_DAILY_STATUS.md
          fi

      - name: Create or update issue comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_TITLE="Daily CI Status"
          ISSUE_NUMBER=$(gh issue list --search "$ISSUE_TITLE in:title" --state open --json number,title | jq -r '.[0].number // empty')
          if [ -n "$ISSUE_NUMBER" ]; then
            gh issue comment "$ISSUE_NUMBER" --body-file CI_DAILY_STATUS.md || true
          else
            gh issue create --title "$ISSUE_TITLE" --body-file CI_DAILY_STATUS.md || true
          fi

      - name: Upload status artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-daily-status-manual-${{ github.run_id }}
          path: CI_DAILY_STATUS.md

