name: Qt Trial Watchdog

on:
  workflow_run:
    workflows: ["Qt Tests (Trial)"]
    types: [completed]

permissions:
  issues: write

jobs:
  open-issue-on-failure:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Create issue for failed Qt Trial run
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run = context.payload.workflow_run;
            const title = `Qt Trial failed: ${run.name} (#${run.run_number}) â€“ ${run.conclusion}`;
            const body = [
              `Workflow: ${run.name}`,
              `Run URL: ${run.html_url}`,
              `Event: ${run.event}`,
              `Head branch: ${run.head_branch}`,
              `Status: ${run.status}`,
              `Conclusion: ${run.conclusion}`,
              `Started: ${run.created_at}`,
              `Updated: ${run.updated_at}`,
              '',
              'Next steps:',
              '- Inspect Setup Qt step logs',
              '- Verify CMake configure flags and paths',
              '- Re-run workflow via workflow_dispatch after fix',
            ].join('\n');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['ci', 'qt-tests', 'triage']
            });
