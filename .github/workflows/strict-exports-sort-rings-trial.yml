name: Trial - Strict Exports (Sort Rings)

on:
  workflow_dispatch:
    inputs:
      rtol:
        description: 'Field comparison rtol (e.g., 1e-6)'
        required: false
        default: '1e-6'

jobs:
  exports-validate-compare:
    runs-on: ubuntu-latest
    concurrency:
      group: trial-strict-exports-sort-rings-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config python3-pip
          python3 -m pip install --user --upgrade pip jsonschema

      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/vcpkg/archives
            vcpkg/installed
            vcpkg_installed
            build/vcpkg_installed
          key: ubuntu-vcpkg-trial-${{ hashFiles('**/vcpkg.json', 'vcpkg-configuration.json') }}-${{ github.run_number }}
          restore-keys: |
            ubuntu-vcpkg-trial-${{ hashFiles('**/vcpkg.json', 'vcpkg-configuration.json') }}-
            ubuntu-vcpkg-trial-

      - name: Setup vcpkg
        shell: bash
        run: |
          export VCPKG_DEFAULT_BINARY_CACHE="$HOME/.cache/vcpkg/archives"
          mkdir -p "$VCPKG_DEFAULT_BINARY_CACHE"
          echo "VCPKG_DEFAULT_BINARY_CACHE=$VCPKG_DEFAULT_BINARY_CACHE" >> $GITHUB_ENV
          echo "VCPKG_BINARY_SOURCES=clear;files,$VCPKG_DEFAULT_BINARY_CACHE,readwrite" >> $GITHUB_ENV

          if [ ! -d "vcpkg/.git" ]; then
            [ -d "vcpkg" ] && rm -rf vcpkg
            git clone https://github.com/microsoft/vcpkg.git vcpkg
          fi
          (cd vcpkg && git fetch --tags --force && git checkout a20d95d3c76906363896754eb1cc93db2a694f16 && ./bootstrap-vcpkg.sh)
          echo "VCPKG_ROOT=$(pwd)/vcpkg" >> $GITHUB_ENV

      - name: Configure with sort-rings
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_EDITOR_QT=OFF -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_MANIFEST_MODE=ON \
            -DVCPKG_TARGET_TRIPLET=x64-linux \
            -DVCPKG_INSTALLED_DIR=vcpkg/installed \
            -DCADGF_USE_NLOHMANN_JSON=ON -DCADGF_SORT_RINGS=ON

      - name: Build export_cli and tests
        run: |
          cmake --build build --config Release --target export_cli --parallel 2
          cmake --build build --config Release --target test_spec_parsing --parallel 2 || true

      - name: Generate scenes via export_cli
        run: |
          EXPORT_CLI="build/tools/export_cli"
          for SCENE in sample holes multi units complex; do
            "$EXPORT_CLI" --out build/exports --scene "$SCENE"
          done
          for SPEC in tools/specs/scene_complex_spec.json \
                      tools/specs/scene_concave_spec.json \
                      tools/specs/scene_nested_holes_spec.json; do
            test -f "$SPEC" && "$EXPORT_CLI" --out build/exports --spec "$SPEC"
          done

      - name: Validate scenes (schema + stats)
        run: |
          STATS_FILE=consistency_stats.txt
          : > "$STATS_FILE"
          for d in build/exports/scene_cli_*; do
            [ -d "$d" ] || continue
            python3 tools/validate_export.py "$d" --schema --stats-out "$STATS_FILE"
          done
          echo '--- Consistency Stats ---'
          cat "$STATS_FILE" || true

      - name: Upload trial artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trial-sort-rings-${{ github.run_id }}
          path: |
            build/exports/scene_cli_*/*
            consistency_stats.txt
