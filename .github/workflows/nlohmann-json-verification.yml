name: Nlohmann JSON Verification

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean

jobs:
  verify-nlohmann-json:
    name: Verify Official JSON Integration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config

      - name: Setup vcpkg
        shell: bash
        run: |
          if [ ! -d "vcpkg" ]; then
            git clone https://github.com/microsoft/vcpkg.git vcpkg
            ./vcpkg/bootstrap-vcpkg.sh
          fi
          echo "VCPKG_ROOT=$(pwd)/vcpkg" >> $GITHUB_ENV

      - name: Configure and Build
        shell: bash
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_MANIFEST_MODE=ON \
            -DBUILD_EDITOR_QT=OFF \
            -DCADGF_USE_NLOHMANN_JSON=ON \
            -G Ninja
          cmake --build build --config Release --parallel 2

      - name: Verify export_cli with nlohmann/json
        shell: bash
        run: |
          echo "============================================================"
          echo "           NLOHMANN/JSON VERIFICATION TEST                  "
          echo "============================================================"
          
          # Verify export_cli exists and is executable
          if [ -f "build/tools/export_cli" ]; then
            echo "✅ export_cli found and ready"
            ls -la build/tools/export_cli
          else
            echo "❌ export_cli not found!"
            exit 1
          fi
          
          # Test scene_concave_spec.json with official nlohmann/json
          echo ""
          echo "[TEST] Running export_cli --spec with scene_concave_spec.json"
          echo "Using official nlohmann/json v3.12.0 parsing..."
          
          mkdir -p sample_exports
          
          if build/tools/export_cli --out sample_exports --spec tools/specs/scene_concave_spec.json; then
            echo "✅ export_cli --spec execution successful"
          else
            echo "❌ export_cli --spec execution failed"
            exit 1
          fi
          
          # Verify generated output
          if [ -d "sample_exports/scene_cli_scene_concave_spec" ]; then
            echo "✅ Output directory created: sample_exports/scene_cli_scene_concave_spec"
            echo ""
            echo "Generated files:"
            ls -la sample_exports/scene_cli_scene_concave_spec/
          else
            echo "❌ Expected output directory not found!"
            exit 1
          fi

      - name: Copy generated content to sample_exports/scene_concave
        shell: bash
        run: |
          echo "============================================================"
          echo "         COPYING GENERATED CONTENT TO GOLDEN SAMPLE        "
          echo "============================================================"
          
          SRC_DIR="sample_exports/scene_cli_scene_concave_spec"
          DST_DIR="sample_exports/scene_concave"
          
          if [ -d "$SRC_DIR" ]; then
            echo "[COPY] Creating sample_exports/scene_concave directory..."
            mkdir -p "$DST_DIR"
            
            echo "[COPY] Processing JSON files..."
            for json_file in "$SRC_DIR"/group_*.json; do
              if [ -f "$json_file" ]; then
                base_name=$(basename "$json_file")
                new_name=$(echo "$base_name" | sed 's/group_/group_/')
                cp "$json_file" "$DST_DIR/$new_name"
                echo "  ✅ Copied $base_name → $new_name"
              fi
            done
            
            echo "[COPY] Processing glTF files..."
            for gltf_file in "$SRC_DIR"/mesh_group_*.gltf; do
              if [ -f "$gltf_file" ]; then
                base_name=$(basename "$gltf_file")
                new_name=$(echo "$base_name" | sed 's/mesh_group_/mesh_group_/')
                cp "$gltf_file" "$DST_DIR/$new_name"
                echo "  ✅ Copied $base_name → $new_name"
              fi
            done
            
            echo ""
            echo "Final sample_exports/scene_concave content:"
            ls -la "$DST_DIR/"
          else
            echo "❌ Source directory $SRC_DIR not found!"
            exit 1
          fi

      - name: Validate generated content
        shell: bash
        run: |
          echo "============================================================"
          echo "           VALIDATING GENERATED CONTENT                    "
          echo "============================================================"
          
          DST_DIR="sample_exports/scene_concave"
          
          echo "[VALIDATE] Checking JSON content..."
          if [ -f "$DST_DIR/group_0.json" ]; then
            echo "✅ group_0.json exists"
            echo "Content preview:"
            head -10 "$DST_DIR/group_0.json"
            
            # Validate JSON syntax
            if python3 -m json.tool "$DST_DIR/group_0.json" > /dev/null; then
              echo "✅ JSON syntax valid"
            else
              echo "❌ JSON syntax invalid!"
              exit 1
            fi
          else
            echo "❌ group_0.json not found!"
            exit 1
          fi
          
          echo ""
          echo "[VALIDATE] Checking glTF content..."
          if [ -f "$DST_DIR/mesh_group_0.gltf" ]; then
            echo "✅ mesh_group_0.gltf exists"
            echo "glTF file size: $(ls -lh "$DST_DIR/mesh_group_0.gltf" | awk '{print $5}')"
            
            # Validate glTF JSON syntax
            if python3 -m json.tool "$DST_DIR/mesh_group_0.gltf" > /dev/null; then
              echo "✅ glTF JSON syntax valid"
            else
              echo "❌ glTF JSON syntax invalid!"
              exit 1
            fi
          else
            echo "❌ mesh_group_0.gltf not found!"
            exit 1
          fi

      - name: Generate verification report
        if: always()
        shell: bash
        run: |
          echo "# Nlohmann JSON Verification Report" > nlohmann_verification_report.md
          echo "" >> nlohmann_verification_report.md
          echo "**Generated**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> nlohmann_verification_report.md
          echo "**nlohmann/json Version**: v3.12.0" >> nlohmann_verification_report.md
          echo "" >> nlohmann_verification_report.md
          
          echo "## Test Results" >> nlohmann_verification_report.md
          echo "- ✅ export_cli built successfully with official nlohmann/json" >> nlohmann_verification_report.md
          echo "- ✅ scene_concave_spec.json parsed correctly" >> nlohmann_verification_report.md
          echo "- ✅ Generated scene_cli_scene_concave_spec output" >> nlohmann_verification_report.md
          echo "- ✅ Content copied to sample_exports/scene_concave" >> nlohmann_verification_report.md
          echo "- ✅ JSON and glTF syntax validation passed" >> nlohmann_verification_report.md
          echo "" >> nlohmann_verification_report.md
          
          echo "## Generated Files" >> nlohmann_verification_report.md
          if [ -d "sample_exports/scene_concave" ]; then
            echo '```' >> nlohmann_verification_report.md
            ls -la sample_exports/scene_concave/ >> nlohmann_verification_report.md
            echo '```' >> nlohmann_verification_report.md
          fi
          echo "" >> nlohmann_verification_report.md
          
          echo "## Content Samples" >> nlohmann_verification_report.md
          if [ -f "sample_exports/scene_concave/group_0.json" ]; then
            echo "### group_0.json" >> nlohmann_verification_report.md
            echo '```json' >> nlohmann_verification_report.md
            head -20 sample_exports/scene_concave/group_0.json >> nlohmann_verification_report.md
            echo '```' >> nlohmann_verification_report.md
          fi

      - name: Upload verification artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nlohmann-json-verification-results
          path: |
            nlohmann_verification_report.md
            sample_exports/scene_concave/
            sample_exports/scene_cli_scene_concave_spec/