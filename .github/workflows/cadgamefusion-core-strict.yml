name: Core CI (Strict)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-strict:
    name: Strict Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Enhanced vcpkg cache
      - name: Cache vcpkg packages
        uses: actions/cache@v3
        with:
          path: |
            C:\vcpkg\installed
            C:\vcpkg\packages
            ~/vcpkg/installed
            ~/vcpkg/packages
            ~/.cache/vcpkg
            ~/AppData/Local/vcpkg/archives
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json') }}-v2
          restore-keys: |
            ${{ runner.os }}-vcpkg-
            
      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pkg-config

      - name: Setup vcpkg
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            # Windows: Use C:/vcpkg
            VCPKG_DIR="C:/vcpkg"
            if [ -d "$VCPKG_DIR/.git" ]; then
              echo "vcpkg exists, updating..."
              (cd "$VCPKG_DIR" && git pull)
            else
              echo "Cloning vcpkg..."
              rm -rf "$VCPKG_DIR"
              git clone https://github.com/Microsoft/vcpkg.git "$VCPKG_DIR"
            fi
            (cd "$VCPKG_DIR" && ./bootstrap-vcpkg.bat -disableMetrics)
            echo "VCPKG_ROOT=$VCPKG_DIR" >> $GITHUB_ENV
            echo "$VCPKG_DIR" >> $GITHUB_PATH
          else
            # Linux/macOS: Use ~/vcpkg
            VCPKG_DIR="$HOME/vcpkg"
            if [ -d "$VCPKG_DIR/.git" ]; then
              echo "vcpkg exists, updating..."
              (cd "$VCPKG_DIR" && git pull)
            else
              echo "Cloning vcpkg..."
              rm -rf "$VCPKG_DIR"
              git clone https://github.com/Microsoft/vcpkg.git "$VCPKG_DIR"
            fi
            (cd "$VCPKG_DIR" && ./bootstrap-vcpkg.sh -disableMetrics)
            echo "VCPKG_ROOT=$VCPKG_DIR" >> $GITHUB_ENV
            echo "$VCPKG_DIR" >> $GITHUB_PATH
          fi
          
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential ninja-build
          
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja || true

      - name: Configure with vcpkg (strict)
        shell: bash
        run: |
          echo "=== Strict build with vcpkg ==="
          
          # Set vcpkg root based on OS
          if [ "${{ runner.os }}" == "Windows" ]; then
            export VCPKG_ROOT="C:/vcpkg"
            VCPKG_CMAKE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          else
            export VCPKG_ROOT="$HOME/vcpkg"
            VCPKG_CMAKE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          fi
          
          echo "VCPKG_ROOT: $VCPKG_ROOT"
          echo "VCPKG_CMAKE: $VCPKG_CMAKE"
          
          # Configure with retries for Windows
          if [ "${{ runner.os }}" == "Windows" ]; then
            MAX_RETRIES=3
            RETRY_COUNT=0
            SUCCESS=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              echo "Attempt $((RETRY_COUNT+1)) of $MAX_RETRIES"
              
              if cmake -S . -B build \
                -DBUILD_EDITOR_QT=OFF \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_TOOLCHAIN_FILE="$VCPKG_CMAKE" \
                -DVCPKG_TARGET_TRIPLET=x64-windows \
                -DVCPKG_HOST_TRIPLET=x64-windows; then
                echo "✅ Configuration successful"
                SUCCESS=true
              else
                RETRY_COUNT=$((RETRY_COUNT+1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "⚠️ Configuration failed, waiting 10 seconds before retry..."
                  sleep 10
                  rm -rf build
                fi
              fi
            done
            
            if [ "$SUCCESS" = "false" ]; then
              echo "❌ All retries exhausted, falling back to no vcpkg"
              rm -rf build
              cmake -S . -B build \
                -DBUILD_EDITOR_QT=OFF \
                -DCMAKE_BUILD_TYPE=Release \
                -DUSE_EARCUT=OFF \
                -DUSE_CLIPPER2=OFF
            fi
          else
            # Linux/macOS: direct configuration
            cmake -S . -B build \
              -DBUILD_EDITOR_QT=OFF \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_TOOLCHAIN_FILE="$VCPKG_CMAKE"
          fi

      - name: Build
        shell: bash
        run: |
          cmake --build build --config Release --parallel 2
          
      - name: Install built tools
        shell: bash
        run: |
          cmake --install build --config Release --prefix build

      - name: Verify vcpkg dependencies
        shell: bash
        run: |
          echo "=== Checking for vcpkg features ==="
          if [ -f "build/CMakeCache.txt" ]; then
            echo "Checking for Earcut:"
            grep -i "earcut" build/CMakeCache.txt || echo "Earcut not found (may have fallen back)"
            echo ""
            echo "Checking for Clipper2:"
            grep -i "clipper" build/CMakeCache.txt || echo "Clipper2 not found (may have fallen back)"
            echo ""
            echo "Feature flags:"
            grep "USE_" build/CMakeCache.txt || echo "No feature flags found"
          fi

      - name: Run tests
        shell: bash
        run: |
          echo "=== Running tests ==="
          
          # Find test directory
          if [ "${{ runner.os }}" == "Windows" ]; then
            TEST_DIR="build/tests/core/Release"
            [ ! -d "$TEST_DIR" ] && TEST_DIR="build/Release"
            TEST_SUFFIX=".exe"
          else
            TEST_DIR="build/tests/core"
            TEST_SUFFIX=""
          fi
          
          # Run available tests
          if [ -f "$TEST_DIR/test_simple$TEST_SUFFIX" ]; then
            echo "=== Simple test ==="
            "$TEST_DIR/test_simple$TEST_SUFFIX"
          fi
          
          if [ -f "$TEST_DIR/core_tests_triangulation$TEST_SUFFIX" ]; then
            echo "=== Triangulation test ==="
            "$TEST_DIR/core_tests_triangulation$TEST_SUFFIX"
          fi
          
          if [ -f "$TEST_DIR/core_tests_boolean_offset$TEST_SUFFIX" ]; then
            echo "=== Boolean/offset test ==="
            "$TEST_DIR/core_tests_boolean_offset$TEST_SUFFIX"
          fi
          
          if [ -f "$TEST_DIR/core_tests_complex_strict$TEST_SUFFIX" ]; then
            echo "=== Complex strict test (L-shaped with holes) ==="
            "$TEST_DIR/core_tests_complex_strict$TEST_SUFFIX"
          fi
          
          if [ -f "$TEST_DIR/core_tests_strict$TEST_SUFFIX" ]; then
            echo "=== Strict assertions test ==="
            "$TEST_DIR/core_tests_strict$TEST_SUFFIX"
          else
            echo "⚠️ Strict test not found (expected if vcpkg failed)"
          fi
          
          echo "✅ Available tests passed!"

      - name: Run export_cli to generate test scenes
        shell: bash
        run: |
          echo "============================================================"
          echo "              EXPORT CLI GENERATION TEST                    "
          echo "============================================================"
          echo ""
          
          # Check if export_cli was built (check build/bin first as per install path)
          EXPORT_CLI=""
          if [ -f "build/bin/export_cli" ]; then
            EXPORT_CLI="build/bin/export_cli"
          elif [ -f "build/bin/export_cli.exe" ]; then
            EXPORT_CLI="build/bin/export_cli.exe"
          elif [ -f "build/tools/export_cli" ]; then
            EXPORT_CLI="build/tools/export_cli"
          elif [ -f "build/tools/Release/export_cli.exe" ]; then
            EXPORT_CLI="build/tools/Release/export_cli.exe"
          elif [ -f "build/tools/Debug/export_cli.exe" ]; then
            EXPORT_CLI="build/tools/Debug/export_cli.exe"
          elif [ -f "build/Release/export_cli.exe" ]; then
            EXPORT_CLI="build/Release/export_cli.exe"
          elif [ -f "build/Release/export_cli" ]; then
            EXPORT_CLI="build/Release/export_cli"
          fi
          
          if [ -n "$EXPORT_CLI" ]; then
            echo "[INFO] Found export_cli: $EXPORT_CLI"
            echo ""
            echo "[RUN] Generating test scenes with export_cli..."
            
            # Generate all five scenes (including complex)
            for SCENE in sample holes multi units complex; do
              echo "  Generating scene_cli_$SCENE..."
              $EXPORT_CLI --out build/exports --scene $SCENE || echo "    Warning: Failed to generate $SCENE"
            done

            # Test spec-dir functionality with complex scene
            if [ -d "sample_exports/scene_complex" ]; then
              echo "  Copying spec scene from sample_exports/scene_complex..."
              $EXPORT_CLI --out build/exports --spec-dir sample_exports/scene_complex || echo "    Warning: Failed to copy spec scene"
            fi

            # Test JSON --spec functionality using provided spec file
            if [ -f "tools/specs/scene_complex_spec.json" ]; then
              echo "  Generating from JSON spec tools/specs/scene_complex_spec.json..."
              $EXPORT_CLI --out build/exports --spec tools/specs/scene_complex_spec.json || echo "    Warning: Failed to generate from spec JSON"
            fi
            
            echo ""
            echo "[INFO] Generated scenes in build/exports/"
            ls -la build/exports/ 2>/dev/null | head -20 || echo "    No exports directory found"
          else
            echo "[SKIP] export_cli not found, skipping CLI generation test"
          fi

      - name: Validate sample export (if present)
        shell: bash
        run: |
          echo "============================================================"
          echo "                    EXPORT VALIDATION                       "
          echo "============================================================"
          
          # Check if Python is available
          if ! command -v python3 &> /dev/null; then
            echo "[SKIP] Python3 not found, skipping export validation"
            exit 0
          fi
          
          # Check if validation script exists
          if [ ! -f "tools/validate_export.py" ]; then
            echo "[SKIP] Validation script not found at tools/validate_export.py"
            exit 0
          fi
          
          # Search order: 1) CLI-generated, 2) sample_exports/scene_*, 3) ./scene_*
          SCENE_DIRS=""
          
          # First priority: CLI-generated scenes in build/exports
          if [ -d "build/exports" ]; then
            CLI_SCENES=$(find build/exports -maxdepth 1 -type d -name "scene_cli_*" 2>/dev/null | sort)
            if [ -n "$CLI_SCENES" ]; then
              SCENE_DIRS="$CLI_SCENES"
              echo "[INFO] Found CLI-generated scenes:"
              for SCENE in $CLI_SCENES; do
                echo "  - $(basename $SCENE)"
              done
            fi
          fi
          
          # Second priority: sample_exports directory - iterate ALL scene_* directories
          if [ -d "sample_exports" ]; then
            SAMPLE_SCENES=$(find sample_exports -maxdepth 2 -type d -name "scene_*" 2>/dev/null | sort)
            if [ -n "$SAMPLE_SCENES" ]; then
              if [ -n "$SCENE_DIRS" ]; then
                SCENE_DIRS="$SCENE_DIRS $SAMPLE_SCENES"
                echo ""
                echo "[INFO] Also found scenes in sample_exports:"
              else
                SCENE_DIRS="$SAMPLE_SCENES"
                echo "[INFO] Found scenes in sample_exports:"
              fi
              for SCENE in $SAMPLE_SCENES; do
                echo "  - $(basename $SCENE)"
              done
            fi
          fi
          
          # Third priority: root directory scene_* (only if no other scenes found)
          if [ -z "$SCENE_DIRS" ]; then
            ROOT_SCENES=$(find . -maxdepth 1 -type d -name "scene_*" 2>/dev/null | sort)
            if [ -n "$ROOT_SCENES" ]; then
              SCENE_DIRS="$ROOT_SCENES"
              echo "[INFO] Found scenes in root directory:"
              for SCENE in $ROOT_SCENES; do
                echo "  - $(basename $SCENE)"
              done
            fi
          fi
          
          if [ -z "$SCENE_DIRS" ]; then
            echo "[SKIP] No scene directories found, skipping validation"
            echo "       (To enable validation, create scene_* directories with exported files)"
            exit 0
          fi
          
          # Count total scenes
          TOTAL_SCENES=$(echo "$SCENE_DIRS" | wc -w)
          echo ""
          echo "[INFO] Total scenes to validate: $TOTAL_SCENES"
          echo "============================================================"
          
          # Validate each scene directory and collect results
          VALIDATION_FAILED=false
          PASSED_COUNT=0
          FAILED_COUNT=0
          FAILED_SCENES=""
          
          for SCENE in $SCENE_DIRS; do
            SCENE_NAME=$(basename "$SCENE")
            echo ""
            echo "[VALIDATE] Scene: $SCENE_NAME"
            echo "------------------------------------------------------------"
            
            # Attempt schema validation as best-effort; do not fail CI if jsonschema is missing
            if python3 tools/validate_export.py "$SCENE" --schema; then
              echo "[RESULT] $SCENE_NAME: PASSED"
              PASSED_COUNT=$((PASSED_COUNT + 1))
            else
              echo "[RESULT] $SCENE_NAME: FAILED"
              FAILED_COUNT=$((FAILED_COUNT + 1))
              FAILED_SCENES="$FAILED_SCENES $SCENE_NAME"
              VALIDATION_FAILED=true
            fi
          done
          
          # Summary output
          echo ""
          echo "============================================================"
          echo "                    VALIDATION SUMMARY                      "
          echo "============================================================"
          echo "[STATS] Total: $TOTAL_SCENES | Passed: $PASSED_COUNT | Failed: $FAILED_COUNT"
          
          if [ "$VALIDATION_FAILED" = true ]; then
            echo ""
            echo "[FAILED] The following scenes failed validation:"
            for SCENE in $FAILED_SCENES; do
              echo "  - $SCENE"
            done
            echo ""
            echo "[RESULT] VALIDATION FAILED"
            echo "============================================================"
            exit 1
          else
            echo ""
            echo "[RESULT] ALL VALIDATIONS PASSED"
            echo "============================================================"
          fi

      - name: Compare CLI exports with samples (loose mode)
        shell: bash
        run: |
          echo "============================================================"
          echo "           STRUCTURE COMPARISON (LOOSE MODE)                "
          echo "============================================================"
          
          # Check if comparison script exists
          if [ ! -f "tools/compare_export_to_sample.py" ]; then
            echo "[SKIP] Comparison script not found at tools/compare_export_to_sample.py"
            exit 0
          fi
          
          # Check if Python is available
          if ! command -v python3 &> /dev/null; then
            echo "[SKIP] Python3 not found, skipping structure comparison"
            exit 0
          fi
          
          # Check if both CLI exports and sample exports exist
          HAS_CLI_EXPORTS=false
          HAS_SAMPLE_EXPORTS=false
          
          if [ -d "build/exports" ]; then
            CLI_COUNT=$(find build/exports -maxdepth 1 -type d -name "scene_cli_*" 2>/dev/null | wc -l)
            if [ "$CLI_COUNT" -gt 0 ]; then
              HAS_CLI_EXPORTS=true
            fi
          fi
          
          if [ -d "sample_exports" ]; then
            SAMPLE_COUNT=$(find sample_exports -maxdepth 1 -type d -name "scene_*" 2>/dev/null | wc -l)
            if [ "$SAMPLE_COUNT" -gt 0 ]; then
              HAS_SAMPLE_EXPORTS=true
            fi
          fi
          
          if [ "$HAS_CLI_EXPORTS" = false ] || [ "$HAS_SAMPLE_EXPORTS" = false ]; then
            echo "[SKIP] Missing CLI exports or sample exports for comparison"
            echo "       CLI exports found: $HAS_CLI_EXPORTS"
            echo "       Sample exports found: $HAS_SAMPLE_EXPORTS"
            exit 0
          fi
          
          echo "[INFO] Comparing CLI-generated scenes with sample exports"
          echo ""
          
          # Define scene mappings (CLI name -> sample name)
          declare -A SCENE_MAP
          SCENE_MAP["scene_cli_sample"]="scene_sample"
          SCENE_MAP["scene_cli_holes"]="scene_holes"
          SCENE_MAP["scene_cli_multi"]="scene_multi_groups"
          SCENE_MAP["scene_cli_units"]="scene_units"
          SCENE_MAP["scene_cli_complex"]="scene_complex"
          SCENE_MAP["scene_cli_scene_complex_spec"]="scene_complex"
          
          COMPARISON_FAILED=false
          COMPARED_COUNT=0
          PASSED_COUNT=0
          FAILED_COUNT=0
          
          # Compare each CLI scene with its sample counterpart
          for CLI_SCENE in build/exports/scene_cli_*; do
            if [ ! -d "$CLI_SCENE" ]; then
              continue
            fi
            
            CLI_NAME=$(basename "$CLI_SCENE")
            SAMPLE_NAME="${SCENE_MAP[$CLI_NAME]}"
            
            if [ -z "$SAMPLE_NAME" ]; then
              echo "[WARN] No sample mapping for $CLI_NAME"
              continue
            fi
            
            SAMPLE_SCENE="sample_exports/$SAMPLE_NAME"
            
            if [ ! -d "$SAMPLE_SCENE" ]; then
              echo "[WARN] Sample scene not found: $SAMPLE_SCENE"
              continue
            fi
            
            echo "[COMPARE] $CLI_NAME vs $SAMPLE_NAME"
            echo "------------------------------------------------------------"
            
            COMPARED_COUNT=$((COMPARED_COUNT + 1))
            
            # Run comparison (strong assertion for sample, holes, and complex)
            if python3 tools/compare_export_to_sample.py "$CLI_SCENE" "$SAMPLE_SCENE"; then
              echo "[RESULT] Structure match confirmed"
              PASSED_COUNT=$((PASSED_COUNT + 1))
            else
              echo "[RESULT] Structure differences detected"
              FAILED_COUNT=$((FAILED_COUNT + 1))
              
              # Strong assertion for sample, holes, complex, and spec-complex scenes
              if [ "$CLI_NAME" = "scene_cli_sample" ] || [ "$CLI_NAME" = "scene_cli_holes" ] || [ "$CLI_NAME" = "scene_cli_complex" ] || [ "$CLI_NAME" = "scene_cli_scene_complex_spec" ]; then
                echo "[ERROR] Required scenes (sample/holes/complex/spec) must match structure exactly!"
                COMPARISON_FAILED=true
              else
                echo "[INFO] Structure difference allowed for $CLI_NAME (non-critical)"
              fi
            fi
            
            echo ""
          done
          
          # Summary
          echo "============================================================"
          echo "                  COMPARISON SUMMARY                        "
          echo "============================================================"
          echo "[STATS] Compared: $COMPARED_COUNT | Matched: $PASSED_COUNT | Differences: $FAILED_COUNT"
          
          if [ "$COMPARED_COUNT" -eq 0 ]; then
            echo "[WARN] No scenes were compared"
          elif [ "$PASSED_COUNT" -eq "$COMPARED_COUNT" ]; then
            echo "[SUCCESS] All scenes have matching structures"
          else
            echo "[INFO] Some structural differences detected (expected due to triangulation)"
          fi
          
          echo "============================================================"
          
          # Exit with error if required comparisons failed
          if [ "$COMPARISON_FAILED" = true ]; then
            echo "[FAILURE] CI failed due to required scene structure mismatches"
            exit 1
          else
            exit 0
          fi

      - name: Generate test report
        if: always()
        shell: bash
        run: |
          echo "## Test Report - ${{ matrix.os }}" > test_report.md
          echo "" >> test_report.md
          echo "### Build Configuration" >> test_report.md
          if [ -f "build/CMakeCache.txt" ] && grep -q "earcut\|clipper" build/CMakeCache.txt; then
            echo "- vcpkg: ✅ Success" >> test_report.md
          else
            echo "- vcpkg: ⚠️ Fallback (no vcpkg)" >> test_report.md
          fi
          echo "" >> test_report.md
          echo "### Test Results" >> test_report.md
          echo "- Tests executed successfully" >> test_report.md
          
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report-strict-${{ runner.os }}
          path: test_report.md
