name: Core Strict - Build and Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable verbose logs'
        required: false
        default: 'false'

jobs:
  build:
    # Toggle Windows non-blocking behavior here: set to 'false' to enforce blocking once mirrors stabilize
    concurrency:
      group: core-strict-build-tests-${{ github.ref }}-${{ matrix.os }}
      cancel-in-progress: true
    runs-on: ${{ matrix.os }}
    continue-on-error: false
    env:
      WINDOWS_CONTINUE_ON_ERROR: 'false'
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: requirements-ci.txt

      - name: Cache vcpkg
        uses: actions/cache@v3
        with:
          path: |
            C:\vcpkg\installed
            C:\vcpkg\packages
            ~/vcpkg/installed
            ~/vcpkg/packages
            ~/.cache/vcpkg
            ~/AppData/Local/vcpkg/archives
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json', '**/vcpkg-windows-minimal.json') }}-v4
          restore-keys: ${{ runner.os }}-vcpkg-

      - name: Setup vcpkg (Windows, with retry)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          set -e
          # Configure explicit files-based binary cache for Windows
          echo "VCPKG_DEFAULT_BINARY_CACHE=$HOME/AppData/Local/vcpkg/archives" >> $GITHUB_ENV
          echo "VCPKG_BINARY_SOURCES=clear;files,$HOME/AppData/Local/vcpkg/archives,readwrite;default" >> $GITHUB_ENV
          mkdir -p "$HOME/AppData/Local/vcpkg/archives" || true
          echo "VCPKG_DEFAULT_TRIPLET=x64-windows" >> $GITHUB_ENV
          VCPKG_DIR="C:/vcpkg"
          retry() {
            local n=0; local max=5; local delay=5
            until "$@"; do
              n=$((n+1))
              if [ $n -ge $max ]; then
                echo "[retry] command failed after $n attempts: $*" >&2
                return 1
              fi
              echo "[retry] attempt $n failed; retrying in ${delay}s..."
              sleep $delay; delay=$((delay*2))
            done
          }
          if [ -d "$VCPKG_DIR/.git" ]; then
            (cd "$VCPKG_DIR" && retry git pull --ff-only)
          else
            rm -rf "$VCPKG_DIR"
            retry git clone https://github.com/Microsoft/vcpkg.git "$VCPKG_DIR"
          fi
          (cd "$VCPKG_DIR" && retry git checkout c9fa965c2a1b1334469b4539063f3ce95383653c)
          (cd "$VCPKG_DIR" && retry ./bootstrap-vcpkg.bat -disableMetrics)
          echo "VCPKG_ROOT=$VCPKG_DIR" >> $GITHUB_ENV
          echo "$VCPKG_DIR" >> $GITHUB_PATH

      - name: Print vcpkg state (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "== vcpkg version =="; vcpkg version || true
          echo "== vcpkg.json (head) =="; head -n 40 vcpkg.json || echo "(vcpkg.json not found)"

      - name: Enable long paths (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          git config --system core.longpaths true || true
          echo "Enabled git core.longpaths=true"

      - name: Setup vcpkg (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          # Configure explicit files-based binary cache for Unix
          echo "VCPKG_DEFAULT_BINARY_CACHE=$HOME/.cache/vcpkg/archives" >> $GITHUB_ENV
          echo "VCPKG_BINARY_SOURCES=clear;files,$HOME/.cache/vcpkg/archives,readwrite;default" >> $GITHUB_ENV
          mkdir -p "$HOME/.cache/vcpkg/archives"
          # Set OS-specific default triplet
          if [ "${{ runner.os }}" = "macOS" ]; then
            echo "VCPKG_DEFAULT_TRIPLET=x64-osx" >> $GITHUB_ENV
          else
            echo "VCPKG_DEFAULT_TRIPLET=x64-linux" >> $GITHUB_ENV
          fi
          VCPKG_DIR="$HOME/vcpkg"
          if [ -d "$VCPKG_DIR/.git" ]; then (cd "$VCPKG_DIR" && git pull --ff-only); else rm -rf "$VCPKG_DIR" && git clone https://github.com/Microsoft/vcpkg.git "$VCPKG_DIR"; fi
          (cd "$VCPKG_DIR" && git checkout c9fa965c2a1b1334469b4539063f3ce95383653c)
          (cd "$VCPKG_DIR" && ./bootstrap-vcpkg.sh -disableMetrics)
          echo "VCPKG_ROOT=$VCPKG_DIR" >> $GITHUB_ENV
          echo "$VCPKG_DIR" >> $GITHUB_PATH

      - name: OS deps
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build build-essential

      - name: Install Python deps
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then
            python -m pip install -r requirements-ci.txt
          fi

      - name: Use minimal vcpkg config for Windows
        if: runner.os == 'Windows'
        shell: bash
        run: |
          if [ -f vcpkg-windows-minimal.json ]; then
            echo "Using minimal vcpkg configuration for Windows to avoid MSYS2 issues"
            cp vcpkg-windows-minimal.json vcpkg.json
          fi

      - name: Configure
        shell: bash
        run: |
          # Ensure cache directories exist and optionally enable debug for cache misses
          if [ "${{ inputs.debug || 'false' }}" = "true" ]; then
            echo "VCPKG_FEATURE_FLAGS=manifests,binarycaching,compilertracking" >> $GITHUB_ENV
            echo "VCPKG_KEEP_ENV_VARS=VCPKG_DEFAULT_BINARY_CACHE,VCPKG_BINARY_SOURCES" >> $GITHUB_ENV
          fi
          if [ "${{ runner.os }}" = "Windows" ]; then
            mkdir -p "$HOME/AppData/Local/vcpkg/archives" || true
          else
            mkdir -p "$HOME/.cache/vcpkg/archives"
          fi
          TOOLCHAIN="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          cmake -S . -B build -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN" -DCMAKE_BUILD_TYPE=Release -DBUILD_EDITOR_QT=OFF -DCADGF_USE_NLOHMANN_JSON=ON -DVCPKG_TARGET_TRIPLET="$VCPKG_DEFAULT_TRIPLET" -G Ninja || \
          cmake -S . -B build -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN" -DCMAKE_BUILD_TYPE=Release -DBUILD_EDITOR_QT=OFF -DCADGF_USE_NLOHMANN_JSON=ON -DVCPKG_TARGET_TRIPLET="$VCPKG_DEFAULT_TRIPLET"

      - name: Build
        run: cmake --build build --config Release --parallel 2

      - name: Run core tests
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then TEST_DIR="build/tests/core/Release"; TEST_SUFFIX=".exe"; else TEST_DIR="build/tests/core"; fi
          for T in test_simple core_tests_triangulation core_tests_boolean_offset core_tests_complex_strict; do
            if [ -f "$TEST_DIR/$T$TEST_SUFFIX" ]; then echo "Running $T"; "$TEST_DIR/$T$TEST_SUFFIX"; fi
          done

      - name: Run tools tests (meta.normalize)
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then TOOL_DIR="build/tests/tools/Release"; SUFFIX=".exe"; else TOOL_DIR="build/tests/tools"; SUFFIX=""; fi
          TGT="$TOOL_DIR/test_meta_normalize$SUFFIX"
          if [ -f "$TGT" ]; then
            echo "Running test_meta_normalize"
            "$TGT"
          else
            echo "test_meta_normalize not found (skipping)"
          fi

      - name: Run tools tests (deterministic ring ordering)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then TOOL_DIR="build/tests/tools/Release"; SUFFIX=".exe"; else TOOL_DIR="build/tests/tools"; SUFFIX=""; fi
          TGT="$TOOL_DIR/test_sort_rings_deterministic$SUFFIX"
          if [ -f "$TGT" ]; then
            echo "Running test_sort_rings_deterministic"
            "$TGT"
          else
            echo "test_sort_rings_deterministic not found (skipping)"
          fi

      - name: Build export_cli tool
        shell: bash
        run: |
          cmake --build build --config Release --target export_cli --parallel 2 || true
          CAND=(
            "build/bin/export_cli"
            "build/bin/export_cli.exe"
            "build/tools/export_cli"
            "build/tools/Release/export_cli.exe"
            "build/Release/export_cli"
            "build/Release/export_cli.exe"
          )
          for p in "${CAND[@]}"; do
            if [ -f "$p" ]; then echo "$p" > export_cli_path.txt; break; fi
          done

      - name: Upload built tools
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: built-tools-${{ runner.os }}
          path: |
            export_cli_path.txt
            build/tools/**/export_cli*
            build/bin/export_cli*

      - name: Upload CMake logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cmake-logs-${{ runner.os }}
          path: |
            build/CMakeFiles/CMakeConfigureLog.yaml
            build/**/CMakeError.log
            build/**/CMakeOutput.log
