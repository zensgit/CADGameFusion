name: Core Strict - Build and Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable verbose logs'
        required: false
        default: 'false'

jobs:
  build:
    # Toggle Windows non-blocking behavior here: set to 'false' to enforce blocking once mirrors stabilize
    concurrency:
      group: core-strict-build-tests-${{ github.ref }}-${{ matrix.os }}
      cancel-in-progress: true
    runs-on: ${{ matrix.os }}
    continue-on-error: false
    env:
      WINDOWS_CONTINUE_ON_ERROR: 'false'
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: requirements-ci.txt

      - name: Cache vcpkg
        uses: actions/cache@v3
        with:
          path: |
            C:\vcpkg\installed
            C:\vcpkg\packages
            ~/vcpkg/installed
            ~/vcpkg/packages
            ~/.cache/vcpkg
            ~/AppData/Local/vcpkg/archives
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json', '**/vcpkg-windows-minimal.json') }}-v4
          restore-keys: ${{ runner.os }}-vcpkg-

      - name: Setup vcpkg (Windows, with retry)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          set -e
          # Configure explicit files-based binary cache for Windows
          CACHE_DIR="$USERPROFILE/AppData/Local/vcpkg/archives"
          echo "VCPKG_DEFAULT_BINARY_CACHE=$CACHE_DIR" >> $GITHUB_ENV
          echo "VCPKG_BINARY_SOURCES=clear;files,$CACHE_DIR,readwrite;default" >> $GITHUB_ENV
          mkdir -p "$CACHE_DIR" || true
          echo "VCPKG_DEFAULT_TRIPLET=x64-windows" >> $GITHUB_ENV
          VCPKG_DIR="C:/vcpkg"
          retry() {
            local n=0; local max=5; local delay=5
            until "$@"; do
              n=$((n+1))
              if [ $n -ge $max ]; then
                echo "[retry] command failed after $n attempts: $*" >&2
                return 1
              fi
              echo "[retry] attempt $n failed; retrying in ${delay}s..."
              sleep $delay; delay=$((delay*2))
            done
          }
          if [ -d "$VCPKG_DIR/.git" ]; then
            (cd "$VCPKG_DIR" && retry git pull --ff-only)
          else
            rm -rf "$VCPKG_DIR"
            retry git clone https://github.com/Microsoft/vcpkg.git "$VCPKG_DIR"
          fi
          (cd "$VCPKG_DIR" && retry git checkout a20d95d3c76906363896754eb1cc93db2a694f16)
          (cd "$VCPKG_DIR" && retry ./bootstrap-vcpkg.bat -disableMetrics)
          echo "VCPKG_ROOT=$VCPKG_DIR" >> $GITHUB_ENV
          echo "$VCPKG_DIR" >> $GITHUB_PATH

      - name: Print vcpkg state (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "== vcpkg version =="; vcpkg version || true
          echo "== vcpkg.json (head) =="; head -n 40 vcpkg.json || echo "(vcpkg.json not found)"

      - name: Enable long paths (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          git config --system core.longpaths true || true
          echo "Enabled git core.longpaths=true"

      - name: Setup vcpkg (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          # Configure explicit files-based binary cache for Unix
          echo "VCPKG_DEFAULT_BINARY_CACHE=$HOME/.cache/vcpkg/archives" >> $GITHUB_ENV
          echo "VCPKG_BINARY_SOURCES=clear;files,$HOME/.cache/vcpkg/archives,readwrite;default" >> $GITHUB_ENV
          mkdir -p "$HOME/.cache/vcpkg/archives"
          # Set OS-specific default triplet
          if [ "${{ runner.os }}" = "macOS" ]; then
            arch="$(uname -m)"
            if [ "$arch" = "arm64" ]; then
              echo "VCPKG_DEFAULT_TRIPLET=arm64-osx" >> $GITHUB_ENV
            else
              echo "VCPKG_DEFAULT_TRIPLET=x64-osx" >> $GITHUB_ENV
            fi
          else
            echo "VCPKG_DEFAULT_TRIPLET=x64-linux" >> $GITHUB_ENV
          fi
          VCPKG_DIR="$HOME/vcpkg"
          if [ -d "$VCPKG_DIR/.git" ]; then (cd "$VCPKG_DIR" && git pull --ff-only); else rm -rf "$VCPKG_DIR" && git clone https://github.com/Microsoft/vcpkg.git "$VCPKG_DIR"; fi
          (cd "$VCPKG_DIR" && git checkout a20d95d3c76906363896754eb1cc93db2a694f16)
          (cd "$VCPKG_DIR" && ./bootstrap-vcpkg.sh -disableMetrics)
          echo "VCPKG_ROOT=$VCPKG_DIR" >> $GITHUB_ENV
          echo "$VCPKG_DIR" >> $GITHUB_PATH

      - name: OS deps
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build build-essential

      - name: OS deps (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja pkg-config || true

      - name: OS deps (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install ninja -y

      - name: Install Python deps
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then
            python -m pip install -r requirements-ci.txt
          fi

      - name: Configure
        shell: bash
        run: |
          # Ensure cache directories exist and optionally enable debug for cache misses
          if [ "${{ inputs.debug || 'false' }}" = "true" ]; then
            echo "VCPKG_FEATURE_FLAGS=manifests,binarycaching,compilertracking" >> $GITHUB_ENV
            echo "VCPKG_KEEP_ENV_VARS=VCPKG_DEFAULT_BINARY_CACHE,VCPKG_BINARY_SOURCES" >> $GITHUB_ENV
          fi
          if [ "${{ runner.os }}" = "Windows" ]; then
            mkdir -p "$HOME/AppData/Local/vcpkg/archives" || true
          else
            mkdir -p "$HOME/.cache/vcpkg/archives"
          fi
          TOOLCHAIN="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          if [ "${{ runner.os }}" = "Windows" ]; then
            # On Windows, avoid Ninja+MinGW from Git Bash; prefer the default Visual Studio generator (MSVC),
            # matching the x64-windows vcpkg triplet libraries.
            cmake -S . -B build -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN" -DBUILD_EDITOR_QT=OFF -DCADGF_USE_NLOHMANN_JSON=ON -DVCPKG_TARGET_TRIPLET="$VCPKG_DEFAULT_TRIPLET"
          else
            cmake -S . -B build -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN" -DCMAKE_BUILD_TYPE=Release -DBUILD_EDITOR_QT=OFF -DCADGF_USE_NLOHMANN_JSON=ON -DVCPKG_TARGET_TRIPLET="$VCPKG_DEFAULT_TRIPLET" -G Ninja || \
            cmake -S . -B build -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN" -DCMAKE_BUILD_TYPE=Release -DBUILD_EDITOR_QT=OFF -DCADGF_USE_NLOHMANN_JSON=ON -DVCPKG_TARGET_TRIPLET="$VCPKG_DEFAULT_TRIPLET"
          fi

      - name: Build
        run: cmake --build build --config Release --parallel 2

      - name: Run core tests
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            export PATH="$(pwd)/build/core/Release:$(pwd)/build/core:$(pwd)/build/vcpkg_installed/x64-windows/bin:$(pwd)/vcpkg_installed/x64-windows/bin:C:/vcpkg/installed/x64-windows/bin:$PATH"
            TEST_DIR="build/tests/core/Release"
            TEST_SUFFIX=".exe"
          else
            TEST_DIR="build/tests/core"
            TEST_SUFFIX=""
          fi
          for T in test_simple core_tests_triangulation core_tests_boolean_offset core_tests_complex_strict; do
            if [ -f "$TEST_DIR/$T$TEST_SUFFIX" ]; then echo "Running $T"; "$TEST_DIR/$T$TEST_SUFFIX"; fi
          done

      - name: Run tools tests (meta.normalize)
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            export PATH="$(pwd)/build/core/Release:$(pwd)/build/core:$(pwd)/build/vcpkg_installed/x64-windows/bin:$(pwd)/vcpkg_installed/x64-windows/bin:C:/vcpkg/installed/x64-windows/bin:$PATH"
          fi
          if [ "${{ runner.os }}" == "Windows" ]; then TOOL_DIR="build/tests/tools/Release"; SUFFIX=".exe"; else TOOL_DIR="build/tests/tools"; SUFFIX=""; fi
          TGT="$TOOL_DIR/test_meta_normalize$SUFFIX"
          if [ -f "$TGT" ]; then
            echo "Running test_meta_normalize"
            "$TGT"
          else
            echo "test_meta_normalize not found (skipping)"
          fi

      - name: Run tools tests (deterministic ring ordering)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then TOOL_DIR="build/tests/tools/Release"; SUFFIX=".exe"; else TOOL_DIR="build/tests/tools"; SUFFIX=""; fi
          TGT="$TOOL_DIR/test_sort_rings_deterministic$SUFFIX"
          if [ -f "$TGT" ]; then
            echo "Running test_sort_rings_deterministic"
            "$TGT"
          else
            echo "test_sort_rings_deterministic not found (skipping)"
          fi

      - name: Build export_cli tool
        shell: bash
        run: |
          cmake --build build --config Release --target export_cli --parallel 2 || true
          CAND=(
            "build/bin/export_cli"
            "build/bin/export_cli.exe"
            "build/tools/export_cli"
            "build/tools/Release/export_cli.exe"
            "build/Release/export_cli"
            "build/Release/export_cli.exe"
          )
          for p in "${CAND[@]}"; do
            if [ -f "$p" ]; then echo "$p" > export_cli_path.txt; break; fi
          done

      - name: Upload built tools
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: built-tools-${{ runner.os }}
          path: |
            export_cli_path.txt
            build/tools/**/export_cli*
            build/bin/export_cli*

      - name: Upload CMake logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cmake-logs-${{ runner.os }}
          path: |
            build/CMakeFiles/CMakeConfigureLog.yaml
            build/**/CMakeError.log
            build/**/CMakeOutput.log

      - name: List vcpkg archives (evidence)
        if: always()
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then CACHE_DIR="$USERPROFILE/AppData/Local/vcpkg/archives"; else CACHE_DIR="$HOME/.cache/vcpkg/archives"; fi
          mkdir -p "$CACHE_DIR"
          {
            echo "# vcpkg archives listing";
            echo "OS: ${{ runner.os }}";
            echo "Dir: $CACHE_DIR";
            echo;
            echo "== Summary ==";
            du -sh "$CACHE_DIR" 2>/dev/null || true;
            echo "files:" $(find "$CACHE_DIR" -type f | wc -l | tr -d ' ');
            echo;
            echo "== Top level ==";
            ls -lah "$CACHE_DIR" || true;
          } > vcpkg_archives_listing.txt

      - name: Upload vcpkg evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-evidence-${{ runner.os }}
          path: vcpkg_archives_listing.txt
      - name: Run example smoke tests (Linux only)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -e
          # Run c_api_minimal test
          ctest --test-dir build -R "c_api_minimal_run" --output-on-failure || true

          # Run doc_export_example directly (non-blocking)
          if [ -f build/doc_export_example ]; then
            echo "Running doc_export_example (non-blocking)"
            ./build/doc_export_example build/out_offset.json || echo "doc_export_example failed (expected without CLIPPER2)"
          fi

          # Optional JSON validation (non-blocking)
          if [ -f tools/validate_doc_export.py ] && [ -f build/out_offset.json ]; then
            echo "Running optional JSON validation for doc_export_example output"
            python3 tools/validate_doc_export.py build/out_offset.json || echo "(warning) JSON validation failed"
          fi
