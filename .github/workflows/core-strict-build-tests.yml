name: Core Strict - Build and Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable verbose logs'
        required: false
        default: 'false'

jobs:
  build:
    concurrency:
      group: core-strict-build-tests-${{ github.ref }}-${{ matrix.os }}
      cancel-in-progress: true
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: requirements-ci.txt

      - name: Cache vcpkg
        uses: actions/cache@v3
        with:
          path: |
            C:\vcpkg\installed
            C:\vcpkg\packages
            ~/vcpkg/installed
            ~/vcpkg/packages
            ~/.cache/vcpkg
            ~/AppData/Local/vcpkg/archives
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json') }}-v3
          restore-keys: ${{ runner.os }}-vcpkg-

      - name: Setup vcpkg
        shell: bash
        run: |
          echo "VCPKG_BINARY_SOURCES=clear;default" >> $GITHUB_ENV
          if [ "${{ runner.os }}" == "Windows" ]; then VCPKG_DIR="C:/vcpkg"; else VCPKG_DIR="$HOME/vcpkg"; fi
          if [ -d "$VCPKG_DIR/.git" ]; then (cd "$VCPKG_DIR" && git pull); else rm -rf "$VCPKG_DIR" && git clone https://github.com/Microsoft/vcpkg.git "$VCPKG_DIR"; fi
          (cd "$VCPKG_DIR" && git checkout c9fa965c2a1b1334469b4539063f3ce95383653c)
          if [ "${{ runner.os }}" == "Windows" ]; then (cd "$VCPKG_DIR" && ./bootstrap-vcpkg.bat -disableMetrics); else (cd "$VCPKG_DIR" && ./bootstrap-vcpkg.sh -disableMetrics); fi
          echo "VCPKG_ROOT=$VCPKG_DIR" >> $GITHUB_ENV
          echo "$VCPKG_DIR" >> $GITHUB_PATH

      - name: OS deps
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build build-essential

      - name: Install Python deps
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then
            python -m pip install -r requirements-ci.txt
          fi

      - name: Configure
        shell: bash
        run: |
          TOOLCHAIN="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          cmake -S . -B build -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN" -DCMAKE_BUILD_TYPE=Release -DBUILD_EDITOR_QT=OFF -DCADGF_USE_NLOHMANN_JSON=ON

      - name: Continue on Windows mirror failures (temporary)
        if: runner.os == 'Windows'
        continue-on-error: true
        run: |
          echo "Windows vcpkg mirror issues may cause transient failures; marking as non-blocking for now."

      - name: Build
        run: cmake --build build --config Release --parallel 2

      - name: Run core tests
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then TEST_DIR="build/tests/core/Release"; TEST_SUFFIX=".exe"; else TEST_DIR="build/tests/core"; fi
          for T in test_simple core_tests_triangulation core_tests_boolean_offset core_tests_complex_strict; do
            if [ -f "$TEST_DIR/$T$TEST_SUFFIX" ]; then echo "Running $T"; "$TEST_DIR/$T$TEST_SUFFIX"; fi
          done

      - name: Build export_cli tool
        shell: bash
        run: |
          cmake --build build --config Release --target export_cli --parallel 2 || true
          CAND=(
            "build/bin/export_cli"
            "build/bin/export_cli.exe"
            "build/tools/export_cli"
            "build/tools/Release/export_cli.exe"
            "build/Release/export_cli"
            "build/Release/export_cli.exe"
          )
          for p in "${CAND[@]}"; do
            if [ -f "$p" ]; then echo "$p" > export_cli_path.txt; break; fi
          done

      - name: Upload built tools
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: built-tools-${{ runner.os }}
          path: |
            export_cli_path.txt
            build/tools/**/export_cli*
            build/bin/export_cli*
