name: Solver Demo (Trial)

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
    paths:
      - 'tools/solve_demo.cpp'
      - 'tools/CMakeLists.txt'
      - 'core/include/core/solver.hpp'
      - 'core/src/solver.cpp'

jobs:
  solver-demo:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config

      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/vcpkg/archives
            vcpkg/installed
            vcpkg_installed
            build/vcpkg_installed
          key: ubuntu-vcpkg-solver-demo-${{ hashFiles('**/vcpkg.json', 'vcpkg-configuration.json') }}-${{ github.run_number }}
          restore-keys: |
            ubuntu-vcpkg-solver-demo-${{ hashFiles('**/vcpkg.json', 'vcpkg-configuration.json') }}-
            ubuntu-vcpkg-solver-demo-

      - name: Setup vcpkg
        shell: bash
        run: |
          export VCPKG_DEFAULT_BINARY_CACHE="$HOME/.cache/vcpkg/archives"
          mkdir -p "$VCPKG_DEFAULT_BINARY_CACHE"
          echo "VCPKG_DEFAULT_BINARY_CACHE=$VCPKG_DEFAULT_BINARY_CACHE" >> $GITHUB_ENV
          echo "VCPKG_BINARY_SOURCES=clear;files,$VCPKG_DEFAULT_BINARY_CACHE,readwrite" >> $GITHUB_ENV

          if [ ! -d "vcpkg/.git" ]; then
            [ -d "vcpkg" ] && rm -rf vcpkg
            git clone https://github.com/microsoft/vcpkg.git vcpkg
          fi
          (cd vcpkg && git fetch --tags --force && git checkout a20d95d3c76906363896754eb1cc93db2a694f16 && ./bootstrap-vcpkg.sh)
          echo "VCPKG_ROOT=$(pwd)/vcpkg" >> $GITHUB_ENV

      - name: Configure
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_EDITOR_QT=OFF \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            -G Ninja

      - name: Build solver demo and tests
        run: |
          cmake --build build --config Release --target solve_demo --parallel 2
          cmake --build build --config Release --target core_tests_solver_poc --parallel 2
          cmake --build build --config Release --target core_tests_solver_constraints --parallel 2

      - name: Run solver demo
        run: |
          if [ -f build/tools/solve_demo ]; then DEMO=build/tools/solve_demo; else DEMO=build/solve_demo; fi
          [ -f "$DEMO" ] || { echo "solve_demo not found"; exit 1; }
          echo "Running: $DEMO samples/project_minimal.json"
          "$DEMO" samples/project_minimal.json

      - name: Run solver tests (if built)
        run: |
          set -e
          for t in \
            build/tests/core/core_tests_solver_poc \
            build/tests/core/core_tests_solver_constraints \
            build/tests/core/Release/core_tests_solver_poc \
            build/tests/core/Release/core_tests_solver_constraints; do
            if [ -f "$t" ]; then echo "Running $t"; "$t"; fi
          done

      - name: Upload artifacts (logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: solver-demo-trial-logs
          path: |
            build/CMakeFiles/CMakeConfigureLog.yaml
            build/**/CMakeError.log
            build/**/CMakeOutput.log
