name: Daily CI Status Report

on:
  schedule:
    - cron: '0 2 * * *'  # 10:00 UTC+8
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  daily-status:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup gh and jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          gh --version || true
      - name: Generate status report
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          : > CI_DAILY_STATUS.md
          echo "# Daily CI Status Snapshot" >> CI_DAILY_STATUS.md
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> CI_DAILY_STATUS.md
          echo "" >> CI_DAILY_STATUS.md
          echo "Baseline: ci-baseline-2025-09-21 (for comparison in case of regressions)" >> CI_DAILY_STATUS.md
          echo "" >> CI_DAILY_STATUS.md
          
          echo "## Windows Nightly - Strict Build Monitor (last 3)" >> CI_DAILY_STATUS.md
          bash scripts/monitor_ci_runs.sh --workflow "Windows Nightly - Strict Build Monitor" --count 3 --interval 10 --max-iterations 1 >> CI_DAILY_STATUS.md || true
          echo "" >> CI_DAILY_STATUS.md
          
          echo "## Core Strict - Build and Tests (last 3)" >> CI_DAILY_STATUS.md
          bash scripts/monitor_ci_runs.sh --workflow "Core Strict - Build and Tests" --count 3 --interval 10 --max-iterations 1 >> CI_DAILY_STATUS.md || true
          echo "" >> CI_DAILY_STATUS.md
          
          echo "## Core Strict - Exports, Validation, Comparison (last 3)" >> CI_DAILY_STATUS.md
          bash scripts/monitor_ci_runs.sh --workflow "Core Strict - Exports, Validation, Comparison" --count 3 --interval 10 --max-iterations 1 >> CI_DAILY_STATUS.md || true
          echo "" >> CI_DAILY_STATUS.md
          
          echo "## Quick Check - Verification + Lint (last 3)" >> CI_DAILY_STATUS.md
          bash scripts/monitor_ci_runs.sh --workflow "Quick Check - Verification + Lint" --count 3 --interval 10 --max-iterations 1 >> CI_DAILY_STATUS.md || true
          echo "" >> CI_DAILY_STATUS.md
          
          echo "## Solver From Project (Trial) (last 3)" >> CI_DAILY_STATUS.md
          bash scripts/monitor_ci_runs.sh --workflow "Solver From Project (Trial)" --count 3 --interval 10 --max-iterations 1 >> CI_DAILY_STATUS.md || true
          echo "" >> CI_DAILY_STATUS.md
          
          # Windows streak summary
          if [ -f scripts/ci_windows_streak.sh ]; then
            echo "## Windows Nightly Streak" >> CI_DAILY_STATUS.md
            bash scripts/ci_windows_streak.sh >> CI_DAILY_STATUS.md || true
            echo "" >> CI_DAILY_STATUS.md
          fi

          # Performance Metrics Summary (lightweight)
          echo "## Performance Metrics (Last 24h)" >> CI_DAILY_STATUS.md
          echo "" >> CI_DAILY_STATUS.md

          # Fetch recent workflow run times
          echo "### Workflow Durations (Last ${RUN_LIMIT:-10} runs)" >> CI_DAILY_STATUS.md
          echo "| Workflow | Runs | Success | p50 | p95 | Avg |" >> CI_DAILY_STATUS.md
          echo "|----------|------|---------|-----|-----|-----|" >> CI_DAILY_STATUS.md
          for workflow in "Core Strict - Build and Tests" "Core Strict - Exports, Validation, Comparison" "Quick Check - Verification + Lint"; do
            bash scripts/ci_metrics_summary.sh --workflow "$workflow" --limit "${RUN_LIMIT:-10}" --markdown-row >> CI_DAILY_STATUS.md || true
          done

          echo "" >> CI_DAILY_STATUS.md
          echo "### 7-Day Trend (placeholder for future enhancement)" >> CI_DAILY_STATUS.md
          for workflow in "Core Strict - Build and Tests" "Core Strict - Exports, Validation, Comparison"; do
            bash scripts/ci_trend_summary.sh --workflow "$workflow" --days 7 --markdown >> CI_DAILY_STATUS.md || true
            echo "" >> CI_DAILY_STATUS.md
          done

          # vcpkg cache hit rate (latest strict exports, with fallbacks)
          echo "### vcpkg Cache Metrics (latest strict exports)" >> CI_DAILY_STATUS.md
          # Prefer the validation workflow file (has guaranteed artifacts); fallback to legacy strict-exports.yml
          RUN_ID=$(gh run list --workflow "core-strict-exports-validation.yml" --limit 1 --json databaseId 2>/dev/null | jq -r '.[0].databaseId // empty')
          if [ -z "$RUN_ID" ]; then
            RUN_ID=$(gh run list --workflow "strict-exports.yml" --limit 1 --json databaseId 2>/dev/null | jq -r '.[0].databaseId // empty')
          fi
          if [ -n "$RUN_ID" ]; then
            echo "Attempting to download artifacts from run $RUN_ID..." >&2
            mkdir -p _tmp_art
            # Try to download with the correct artifact name
            gh run download "$RUN_ID" -n "strict-exports-reports-Linux" -D _tmp_art >/dev/null 2>&1 || \
            gh run download "$RUN_ID" -n "strict-exports-reports-Ubuntu" -D _tmp_art >/dev/null 2>&1 || \
            gh run download "$RUN_ID" -n "strict-exports-reports-ubuntu-latest" -D _tmp_art >/dev/null 2>&1 || true

            # Check for the stats file and validate JSON
            STATS_FILE=""
            if [ -f "_tmp_art/build/vcpkg_cache_stats.json" ]; then
              STATS_FILE="_tmp_art/build/vcpkg_cache_stats.json"
            elif [ -f "_tmp_art/vcpkg_cache_stats.json" ]; then
              STATS_FILE="_tmp_art/vcpkg_cache_stats.json"
            fi

            if [ -n "$STATS_FILE" ]; then
              # Validate JSON first
              if jq -e . "$STATS_FILE" >/dev/null 2>&1; then
                HIT=$(jq -r '.hit_rate // "N/A"' "$STATS_FILE")
                INST=$(jq -r '.installing // "N/A"' "$STATS_FILE")
                REST=$(jq -r '.restored // "N/A"' "$STATS_FILE")
                TOTAL=$(jq -r '.total_signals // "N/A"' "$STATS_FILE")
                CACHEABLE=$(jq -r '.cacheable // true' "$STATS_FILE")
                if [ "$CACHEABLE" = "false" ]; then
                  echo "- vcpkg: No cacheable ports detected (likely header-only); hit rate = N/A" >> CI_DAILY_STATUS.md
                else
                  echo "- Cache Hit Rate: ${HIT}% (restored=${REST}, installing=${INST}, total=${TOTAL})" >> CI_DAILY_STATUS.md
                fi
              else
                echo "- Cache metrics JSON invalid (parsing error)" >> CI_DAILY_STATUS.md
                echo "Debug: Invalid JSON content:" >&2
                cat "$STATS_FILE" >&2 || true
              fi
            else
              echo "- Cache metrics not found in strict-exports artifacts; trying build-tests artifacts as fallback" >> CI_DAILY_STATUS.md
              rm -rf _tmp_art && mkdir -p _tmp_art
              gh run download "$RUN_ID" -n "build-tests-reports-Ubuntu" -D _tmp_art >/dev/null 2>&1 || \
              gh run download "$RUN_ID" -n "build-tests-reports-Linux" -D _tmp_art >/dev/null 2>&1 || \
              gh run download "$RUN_ID" -n "build-tests-reports-macOS" -D _tmp_art >/dev/null 2>&1 || \
              gh run download "$RUN_ID" -n "build-tests-reports-Windows" -D _tmp_art >/dev/null 2>&1 || true

              if [ -f "_tmp_art/build/vcpkg_cache_stats.json" ]; then
                STATS_FILE="_tmp_art/build/vcpkg_cache_stats.json"
              elif [ -f "_tmp_art/vcpkg_cache_stats.json" ]; then
                STATS_FILE="_tmp_art/vcpkg_cache_stats.json"
              fi

              if [ -n "$STATS_FILE" ] && jq -e . "$STATS_FILE" >/dev/null 2>&1; then
                HIT=$(jq -r '.hit_rate // "N/A"' "$STATS_FILE")
                INST=$(jq -r '.installing // "N/A"' "$STATS_FILE")
                REST=$(jq -r '.restored // "N/A"' "$STATS_FILE")
                TOTAL=$(jq -r '.total_signals // "N/A"' "$STATS_FILE")
                CACHEABLE=$(jq -r '.cacheable // true' "$STATS_FILE")
                if [ "$CACHEABLE" = "false" ]; then
                  echo "- vcpkg: No cacheable ports detected (likely header-only); hit rate = N/A (from build-tests)" >> CI_DAILY_STATUS.md
                else
                  echo "- Cache Hit Rate (from build-tests): ${HIT}% (restored=${REST}, installing=${INST}, total=${TOTAL})" >> CI_DAILY_STATUS.md
                fi
              else
                echo "- Cache metrics not available (run may not have used vcpkg or artifact names differ)" >> CI_DAILY_STATUS.md
                echo "Debug: Listing available artifacts for run $RUN_ID" >&2
                gh run view "$RUN_ID" --json artifacts --jq '.artifacts[].name' >&2 || true
                ls -la _tmp_art/ >&2 || true
              fi
            fi
            rm -rf _tmp_art
          else
            echo "- No recent strict exports run found" >> CI_DAILY_STATUS.md
          fi
          echo "" >> CI_DAILY_STATUS.md
          echo "" >> CI_DAILY_STATUS.md
      - name: Create or update issue comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_TITLE="Daily CI Status"
          ISSUE_NUMBER=$(gh issue list --search "$ISSUE_TITLE in:title" --state open --json number,title | jq -r '.[0].number // empty')
          if [ -z "$ISSUE_NUMBER" ]; then
            gh issue create --title "$ISSUE_TITLE" --body "Automated CI daily status thread." || true
            ISSUE_NUMBER=$(gh issue list --search "$ISSUE_TITLE in:title" --state open --json number | jq -r '.[0].number')
          fi
          {
            echo "**Latest Session Links**";
            echo "- Checkpoint: session/SESSION_CHECKPOINT_LATEST.md";
            echo "- Snapshot: session/SNAPSHOT_LATEST.md";
            echo "";
            echo "_Note: if generated in an offline environment, some metrics may appear as placeholders (0). Re-run with network to populate actual values._";
            echo "";
            cat CI_DAILY_STATUS.md;
          } > CI_DAILY_STATUS_WITH_LINKS.md
          gh issue comment "$ISSUE_NUMBER" --body-file CI_DAILY_STATUS_WITH_LINKS.md || true
      - name: Upload status artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-daily-status-${{ github.run_id }}
          path: CI_DAILY_STATUS.md
