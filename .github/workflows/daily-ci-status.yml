name: Daily CI Status Report

on:
  schedule:
    - cron: '0 2 * * *'  # 10:00 UTC+8
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  daily-status:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup gh and jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          gh --version || true
      - name: Generate status report
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          : > CI_DAILY_STATUS.md
          echo "# Daily CI Status Snapshot" >> CI_DAILY_STATUS.md
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> CI_DAILY_STATUS.md
          echo "" >> CI_DAILY_STATUS.md
          
          echo "## Windows Nightly - Strict Build Monitor (last 3)" >> CI_DAILY_STATUS.md
          bash scripts/monitor_ci_runs.sh --workflow "Windows Nightly - Strict Build Monitor" --count 3 --interval 10 --max-iterations 1 >> CI_DAILY_STATUS.md || true
          echo "" >> CI_DAILY_STATUS.md
          
          echo "## Core Strict - Build and Tests (last 3)" >> CI_DAILY_STATUS.md
          bash scripts/monitor_ci_runs.sh --workflow "Core Strict - Build and Tests" --count 3 --interval 10 --max-iterations 1 >> CI_DAILY_STATUS.md || true
          echo "" >> CI_DAILY_STATUS.md
          
          echo "## Core Strict - Exports, Validation, Comparison (last 3)" >> CI_DAILY_STATUS.md
          bash scripts/monitor_ci_runs.sh --workflow "Core Strict - Exports, Validation, Comparison" --count 3 --interval 10 --max-iterations 1 >> CI_DAILY_STATUS.md || true
          echo "" >> CI_DAILY_STATUS.md
          
          echo "## Quick Check - Verification + Lint (last 3)" >> CI_DAILY_STATUS.md
          bash scripts/monitor_ci_runs.sh --workflow "Quick Check - Verification + Lint" --count 3 --interval 10 --max-iterations 1 >> CI_DAILY_STATUS.md || true
          echo "" >> CI_DAILY_STATUS.md
          
          echo "## Solver From Project (Trial) (last 3)" >> CI_DAILY_STATUS.md
          bash scripts/monitor_ci_runs.sh --workflow "Solver From Project (Trial)" --count 3 --interval 10 --max-iterations 1 >> CI_DAILY_STATUS.md || true
          echo "" >> CI_DAILY_STATUS.md
          
          # Windows streak summary
          if [ -f scripts/ci_windows_streak.sh ]; then
            echo "## Windows Nightly Streak" >> CI_DAILY_STATUS.md
            bash scripts/ci_windows_streak.sh >> CI_DAILY_STATUS.md || true
            echo "" >> CI_DAILY_STATUS.md
          fi
      - name: Create or update issue comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_TITLE="Daily CI Status"
          ISSUE_NUMBER=$(gh issue list --search "$ISSUE_TITLE in:title" --state open --json number,title | jq -r '.[0].number // empty')
          if [ -z "$ISSUE_NUMBER" ]; then
            gh issue create --title "$ISSUE_TITLE" --body "Automated CI daily status thread." || true
            ISSUE_NUMBER=$(gh issue list --search "$ISSUE_TITLE in:title" --state open --json number | jq -r '.[0].number')
          fi
          {
            echo "**Latest Session Links**";
            echo "- Checkpoint: session/SESSION_CHECKPOINT_LATEST.md";
            echo "- Snapshot: session/SNAPSHOT_LATEST.md";
            echo "";
            cat CI_DAILY_STATUS.md;
          } > CI_DAILY_STATUS_WITH_LINKS.md
          gh issue comment "$ISSUE_NUMBER" --body-file CI_DAILY_STATUS_WITH_LINKS.md || true
      - name: Upload status artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-daily-status-${{ github.run_id }}
          path: CI_DAILY_STATUS.md
