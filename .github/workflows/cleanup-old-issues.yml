name: Cleanup Old Auto-Generated Issues

on:
  schedule:
    # Run weekly on Sundays at 00:00 UTC (08:00 UTC+8)
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      days_threshold:
        description: 'Close issues older than N days'
        required: false
        default: '30'
      dry_run:
        description: 'Dry run (list issues without closing)'
        required: false
        default: 'false'
        type: boolean

permissions:
  issues: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old auto-generated issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Use github.event.inputs so schedule runs don't fail workflow parsing.
          DAYS_THRESHOLD: ${{ github.event.inputs.days_threshold || '30' }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          set -e

          echo "üßπ Starting cleanup of old auto-generated issues..."
          echo "Threshold: ${DAYS_THRESHOLD} days"
          echo "Dry run: ${DRY_RUN}"

          # Calculate cutoff date (DAYS_THRESHOLD days ago)
          if [[ "$OSTYPE" == "darwin"* ]]; then
            CUTOFF_DATE=$(date -v-${DAYS_THRESHOLD}d -u '+%Y-%m-%d')
          else
            CUTOFF_DATE=$(date -u -d "${DAYS_THRESHOLD} days ago" '+%Y-%m-%d')
          fi

          echo "Cutoff date: ${CUTOFF_DATE}"
          echo ""

          # Patterns for auto-generated issues to clean up
          PATTERNS=(
            "Daily CI Status"
            "Weekly CI Trend Digest"
            "Auto Daily After Exports"
          )

          CLOSED_COUNT=0
          SKIPPED_COUNT=0

          for pattern in "${PATTERNS[@]}"; do
            echo "üîç Searching for issues matching: '$pattern'"

            # Get all open issues matching the pattern
            ISSUES=$(gh issue list \
              --state open \
              --search "\"$pattern\" in:title" \
              --json number,title,createdAt \
              --jq ".[] | select(.createdAt < \"${CUTOFF_DATE}\") | @json")

            if [ -z "$ISSUES" ]; then
              echo "  ‚úì No old issues found"
              continue
            fi

            echo "$ISSUES" | while IFS= read -r issue_json; do
              NUMBER=$(echo "$issue_json" | jq -r '.number')
              TITLE=$(echo "$issue_json" | jq -r '.title')
              CREATED=$(echo "$issue_json" | jq -r '.createdAt[:10]')

              echo "  üìù Issue #${NUMBER}: ${TITLE} (created: ${CREATED})"

              if [ "$DRY_RUN" = "true" ]; then
                echo "     [DRY RUN] Would close this issue"
                SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
              else
                # Close the issue with a comment
                COMMENT="$(
                  printf '%b' "ü§ñ Ëá™Âä®ÂÖ≥Èó≠ÔºöÊ≠§Ëá™Âä®ÁîüÊàêÁöÑissueÂ∑≤Ë∂ÖËøá${DAYS_THRESHOLD}Â§©„ÄÇ\\n\\nÂàõÂª∫Êó•Êúü: ${CREATED}\\nÂÖ≥Èó≠Êó•Êúü: $(date -u '+%Y-%m-%d')\\n\\nÊúÄÊñ∞ÁöÑCIÁä∂ÊÄÅÂèØÈÄöËøá‰ª•‰∏ãÊñπÂºèÊü•ÁúãÔºö\\n- Êü•ÁúãÊúÄÊñ∞ÁöÑworkflowËøêË°å: https://github.com/${{ github.repository }}/actions\\n- Êü•ÁúãDaily CI Status Report: https://github.com/${{ github.repository }}/actions/workflows/daily-ci-status.yml\\n\\nÊ≠§Êìç‰ΩúÁî± \\`cleanup-old-issues\\` Â∑•‰ΩúÊµÅËá™Âä®ÊâßË°å„ÄÇ"
                )"

                gh issue close "$NUMBER" \
                  --comment "$COMMENT" \
                  && echo "     ‚úÖ Closed" \
                  || echo "     ‚ùå Failed to close"

                CLOSED_COUNT=$((CLOSED_COUNT + 1))

                # Add a small delay to avoid rate limiting
                sleep 1
              fi
            done
          done

          echo ""
          echo "üìä Summary:"
          if [ "$DRY_RUN" = "true" ]; then
            echo "  Would close: ${SKIPPED_COUNT} issues"
          else
            echo "  Closed: ${CLOSED_COUNT} issues"
          fi
          echo "‚ú® Cleanup completed!"

      - name: Create summary
        if: always()
        run: |
          echo "### Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Threshold**: ${{ github.event.inputs.days_threshold || '30' }} days" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: ${{ github.event.inputs.dry_run == 'true' && 'Dry Run' || 'Live' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for detailed results." >> $GITHUB_STEP_SUMMARY
