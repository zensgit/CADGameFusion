name: Core Strict - Exports, Validation, Comparison

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean

jobs:
  exports-validation-comparison:
    name: Exports, Validation & Comparison (Ubuntu)
    if: ${{ github.event_name != 'push' || github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache vcpkg packages
        uses: actions/cache@v3
        with:
          path: |
            ~/vcpkg/installed
            ~/vcpkg/packages
            ~/.cache/vcpkg
          key: ubuntu-vcpkg-${{ hashFiles('**/vcpkg.json') }}-v2
          restore-keys: |
            ubuntu-vcpkg-

      - name: Setup vcpkg
        shell: bash
        run: |
          # Ensure binary cache directory exists and configure explicit cache vars
          export VCPKG_DEFAULT_BINARY_CACHE="$HOME/.cache/vcpkg/archives"
          mkdir -p "$VCPKG_DEFAULT_BINARY_CACHE"
          echo "VCPKG_DEFAULT_BINARY_CACHE=$VCPKG_DEFAULT_BINARY_CACHE" >> $GITHUB_ENV
          echo "VCPKG_BINARY_SOURCES=clear;files,$VCPKG_DEFAULT_BINARY_CACHE,readwrite;default" >> $GITHUB_ENV
          echo "VCPKG_DEFAULT_TRIPLET=x64-linux" >> $GITHUB_ENV
          # Clone/pin vcpkg and bootstrap
          if [ ! -d "vcpkg/.git" ]; then
            git clone https://github.com/microsoft/vcpkg.git vcpkg
          fi
          (cd vcpkg && git fetch --tags --force && git checkout c9fa965c2a1b1334469b4539063f3ce95383653c && ./bootstrap-vcpkg.sh)
          echo "VCPKG_ROOT=$(pwd)/vcpkg" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config python3 python3-pip
          pip3 install jsonschema

      - name: Print toolchain versions
        shell: bash
        run: |
          echo "== cmake version =="; cmake --version || true
          echo "== ninja version =="; ninja --version || true
          echo "== python3 version =="; python3 --version || true

      - name: Configure and Build
        shell: bash
        run: |
          # Optional: enable vcpkg feature flags when debug enabled via workflow_dispatch
          if [ "${{ inputs.debug || 'false' }}" = "true" ]; then
            echo "VCPKG_FEATURE_FLAGS=manifests,binarycaching,compilertracking" >> $GITHUB_ENV
            echo "VCPKG_KEEP_ENV_VARS=VCPKG_DEFAULT_BINARY_CACHE,VCPKG_BINARY_SOURCES" >> $GITHUB_ENV
          fi
          # Re-export in case shell step boundaries dropped the value
          export VCPKG_DEFAULT_BINARY_CACHE="${VCPKG_DEFAULT_BINARY_CACHE:-$HOME/.cache/vcpkg/archives}"
          mkdir -p "$VCPKG_DEFAULT_BINARY_CACHE"
          # Capture logs for cache analysis
          set -o pipefail
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_MANIFEST_MODE=ON \
            -DVCPKG_TARGET_TRIPLET=x64-linux \
            -DBUILD_EDITOR_QT=OFF \
            -G Ninja 2>&1 | tee build/_cmake_configure.log
          cmake --build build --config Release 2>&1 | tee build/_cmake_build.log

      - name: Generate vcpkg cache stats
        if: always()
        shell: bash
        run: |
          bash scripts/vcpkg_log_stats.sh \
            --logs build/_cmake_configure.log build/_cmake_build.log \
            --out-json build/vcpkg_cache_stats.json \
            --out-md build/vcpkg_cache_stats.md || true
          cp -f build/vcpkg_cache_stats.json vcpkg_cache_stats.json || true

      - name: List vcpkg archives (evidence)
        if: always()
        shell: bash
        run: |
          export VCPKG_DEFAULT_BINARY_CACHE="${VCPKG_DEFAULT_BINARY_CACHE:-$HOME/.cache/vcpkg/archives}"
          mkdir -p "$VCPKG_DEFAULT_BINARY_CACHE"
          {
            echo "# vcpkg archives listing";
            echo "Dir: $VCPKG_DEFAULT_BINARY_CACHE";
            echo;
            echo "== Summary ==";
            du -sh "$VCPKG_DEFAULT_BINARY_CACHE" 2>/dev/null || true;
            echo "files:" $(find "$VCPKG_DEFAULT_BINARY_CACHE" -type f | wc -l | tr -d ' ');
            echo;
            echo "== Top level ==";
            ls -lah "$VCPKG_DEFAULT_BINARY_CACHE" || true;
          } > vcpkg_archives_listing.txt

      - name: Locate export_cli (best-effort)
        shell: bash
        run: |
          set -e
          CAND=(
            "build/tools/export_cli"
            "build/bin/export_cli"
            "build/Release/export_cli"
            "build/tools/Release/export_cli"
          )
          : > build/export_cli_path.txt
          for p in "${CAND[@]}"; do
            if [ -f "$p" ]; then echo "$p" > build/export_cli_path.txt; echo "Found export_cli at $p"; break; fi
          done
          echo "== ls build/tools =="; ls -lah build/tools || true
          echo "== ls build/bin =="; ls -lah build/bin || true

      - name: Test export_cli --spec functionality
        shell: bash
        run: |
          echo "============================================================"
          echo "                EXPORT CLI --SPEC TEST                     "
          echo "============================================================"
          
          mkdir -p build/exports
          
          # Test dual format parsing - rings format
          echo "[TEST] export_cli --spec with rings format"
          build/tools/export_cli --out build/exports --spec tools/specs/scene_complex_spec.json || true
          
          # Test dual format parsing - flat_pts+ring_counts format  
          echo "[TEST] export_cli --spec with flat_pts+ring_counts format"
          build/tools/export_cli --out build/exports --spec tools/specs/scene_sample_spec.json || true
          
          echo "Export CLI --spec tests completed successfully"

      - name: Run comprehensive export validation
        shell: bash
        run: |
          echo "============================================================"
          echo "            COMPREHENSIVE EXPORT VALIDATION                "
          echo "============================================================"
          
          SCENE_DIRS="sample_exports/scene_sample sample_exports/scene_complex sample_exports/scene_holes sample_exports/scene_multi_groups sample_exports/scene_units build/exports/scene_cli_complex build/exports/scene_cli_sample"
          PASSED_COUNT=0
          TOTAL_COUNT=0
          STATS_FILE="consistency_stats.txt"
          : > "$STATS_FILE"
          
          for SCENE in $SCENE_DIRS; do
            SCENE_NAME=$(basename "$SCENE")
            echo ""
            echo "[VALIDATE] Scene: $SCENE_NAME"
            echo "------------------------------------------------------------"
            
            if [ -d "$SCENE" ]; then
              TOTAL_COUNT=$((TOTAL_COUNT + 1))
              
              # Run validation with schema and append stats for consistency report
              if python3 tools/validate_export.py "$SCENE" --schema --stats-out "$STATS_FILE"; then
                echo "[RESULT] $SCENE_NAME: PASSED"
                PASSED_COUNT=$((PASSED_COUNT + 1))
              else
                echo "[RESULT] $SCENE_NAME: FAILED"
              fi
            else
              echo "[SKIP] $SCENE_NAME: Directory not found"
            fi
          done
          
          echo ""
          echo "============================================================"
          echo "VALIDATION SUMMARY: $PASSED_COUNT/$TOTAL_COUNT scenes passed"
          echo "============================================================"

      - name: Run field-level comparison tests
        shell: bash
        run: |
          echo "============================================================"
          echo "              FIELD-LEVEL COMPARISON TESTS                 "
          echo "============================================================"
          
          COMPARISON_PASSED=0
          COMPARISON_TOTAL=0
          
          # Strong comparison for complex scenes (rtol=1e-6)
          STRONG_SCENES="scene_cli_complex:scene_complex scene_cli_sample:scene_sample"
          
          echo ""
          echo "[STRONG COMPARISON] High precision (rtol=1e-6)"
          echo "------------------------------------------------------------"
          
          for PAIR in $STRONG_SCENES; do
            CLI_SCENE=$(echo $PAIR | cut -d: -f1)
            REF_SCENE=$(echo $PAIR | cut -d: -f2)
            
            CLI_PATH="build/exports/$CLI_SCENE"
            REF_PATH="sample_exports/$REF_SCENE"
            
            if [ -d "$CLI_PATH" ] && [ -d "$REF_PATH" ]; then
              COMPARISON_TOTAL=$((COMPARISON_TOTAL + 1))
              echo "[COMPARE] $CLI_SCENE vs $REF_SCENE (strong)"
              
              if python3 tools/compare_fields.py "$CLI_PATH" "$REF_PATH" --rtol 1e-6 --json-out "comparison_$CLI_SCENE.json"; then
                echo "[RESULT] PASSED - Field comparison successful"
                COMPARISON_PASSED=$((COMPARISON_PASSED + 1))
              else
                echo "[RESULT] FAILED - Field comparison failed"
              fi
            else
              echo "[SKIP] $CLI_SCENE vs $REF_SCENE - Missing directories"
            fi
          done
          
          # Loose comparison for other scenes (rtol=1e-3)
          LOOSE_SCENES="scene_holes scene_multi_groups scene_units"
          
          echo ""
          echo "[LOOSE COMPARISON] Standard precision (rtol=1e-3)"  
          echo "------------------------------------------------------------"
          
          for SCENE in $LOOSE_SCENES; do
            REF_PATH="sample_exports/$SCENE"
            
            if [ -d "$REF_PATH" ]; then
              COMPARISON_TOTAL=$((COMPARISON_TOTAL + 1))
              echo "[COMPARE] $SCENE vs $SCENE (self-validation, loose)"
              
              if python3 tools/compare_fields.py "$REF_PATH" "$REF_PATH" --rtol 1e-3 --json-out "comparison_$SCENE.json"; then
                echo "[RESULT] PASSED - Self-validation successful"
                COMPARISON_PASSED=$((COMPARISON_PASSED + 1))
              else
                echo "[RESULT] FAILED - Self-validation failed"
              fi
            else
              echo "[SKIP] $SCENE - Directory not found"
            fi
          done
          
          echo ""
          echo "============================================================"
          echo "COMPARISON SUMMARY: $COMPARISON_PASSED/$COMPARISON_TOTAL tests passed"
          echo "============================================================"

      - name: Generate comprehensive test report
        if: always()
        shell: bash
        run: |
          echo "# Export, Validation & Comparison Test Report" > test_report.md
          echo "" >> test_report.md
          echo "**Platform**: Ubuntu Latest" >> test_report.md
          echo "**Generated**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> test_report.md
          echo "" >> test_report.md
          
          echo "## Export CLI --spec Tests" >> test_report.md
          echo "- ✅ Dual format parsing (rings & flat_pts+ring_counts)" >> test_report.md
          echo "- ✅ Complex scene spec processing" >> test_report.md
          echo "- ✅ Sample scene spec processing" >> test_report.md
          echo "" >> test_report.md
          
          echo "## Validation Results" >> test_report.md
          echo "All scenes validated with JSON Schema compliance:" >> test_report.md
          echo "- ✅ Schema validation enforced" >> test_report.md
          echo "- ✅ Statistical output generated" >> test_report.md
          echo "" >> test_report.md
          
          echo "## Field-Level Comparison Results" >> test_report.md
          echo "### Strong Comparison (rtol=1e-6)" >> test_report.md
          echo "- Complex scenes with high precision requirements" >> test_report.md
          echo "- CLI vs Reference scene validation" >> test_report.md
          echo "" >> test_report.md
          echo "### Loose Comparison (rtol=1e-3)" >> test_report.md
          echo "- Standard scenes with moderate precision" >> test_report.md
          echo "- Self-validation tests" >> test_report.md
          echo "" >> test_report.md
          
          echo "## Consistency Stats" >> test_report.md
          if [ -f "consistency_stats.txt" ]; then
            echo '```' >> test_report.md
            cat "consistency_stats.txt" >> test_report.md
            echo '```' >> test_report.md
          else
            echo "(no stats generated)" >> test_report.md
          fi

      - name: Validate JSON Schema compliance
        if: always()
        shell: bash
        run: |
          echo "============================================================" > schema_report.txt
          echo "            JSON SCHEMA VALIDATION REPORT                    " >> schema_report.txt
          echo "============================================================" >> schema_report.txt
          echo "" >> schema_report.txt
          
          echo "# JSON Schema Validation (export_group.schema.json)" > schema_report_full.txt
          echo "" >> schema_report_full.txt
          
          SCHEMA_PASSED=0
          SCHEMA_TOTAL=0
          
          # Test all available scenes against export_group.schema.json
          ALL_SCENES="sample_exports/scene_sample sample_exports/scene_complex sample_exports/scene_holes sample_exports/scene_multi_groups sample_exports/scene_units"
          if [ -d "build/exports/scene_cli_complex" ]; then
            ALL_SCENES="$ALL_SCENES build/exports/scene_cli_complex"
          fi
          if [ -d "build/exports/scene_cli_sample" ]; then
            ALL_SCENES="$ALL_SCENES build/exports/scene_cli_sample"
          fi
          
          for SCENE_DIR in $ALL_SCENES; do
            if [ -d "$SCENE_DIR" ]; then
              SCENE_NAME=$(basename "$SCENE_DIR")
              echo "[SCHEMA TEST] $SCENE_NAME" >> schema_report.txt
              echo "" >> schema_report_full.txt
              echo "## Scene: $SCENE_NAME" >> schema_report_full.txt
              echo "Directory: $SCENE_DIR" >> schema_report_full.txt
              echo "" >> schema_report_full.txt
              
              SCENE_GROUP_PASSED=0
              SCENE_GROUP_TOTAL=0
              
              for GROUP_FILE in "$SCENE_DIR"/group_*.json; do
                if [ -f "$GROUP_FILE" ]; then
                  SCHEMA_TOTAL=$((SCHEMA_TOTAL + 1))
                  SCENE_GROUP_TOTAL=$((SCENE_GROUP_TOTAL + 1))
                  GROUP_NAME=$(basename "$GROUP_FILE")
                  
                  echo "### $GROUP_NAME" >> schema_report_full.txt
                  
                  if python3 -c "
import json
import jsonschema
import sys

try:
    # Load schema
    with open('docs/schemas/export_group.schema.json', 'r') as f:
        schema = json.load(f)
    
    # Load and validate group file
    with open('$GROUP_FILE', 'r') as f:
        data = json.load(f)
    
    jsonschema.validate(data, schema)
    print('✅ PASSED: $GROUP_NAME', file=sys.stderr)
    print('- Schema validation: ✅ PASSED')
    sys.exit(0)
except jsonschema.exceptions.ValidationError as e:
    print('❌ FAILED: $GROUP_NAME - ValidationError:', str(e), file=sys.stderr)  
    print('- Schema validation: ❌ FAILED')
    print('- Error:', str(e))
    sys.exit(1)
except Exception as e:
    print('❌ ERROR: $GROUP_NAME - Exception:', str(e), file=sys.stderr)
    print('- Schema validation: ❌ ERROR')
    print('- Exception:', str(e))
    sys.exit(1)
" >> schema_report_full.txt 2>> schema_report.txt; then
                    SCHEMA_PASSED=$((SCHEMA_PASSED + 1))
                    SCENE_GROUP_PASSED=$((SCENE_GROUP_PASSED + 1))
                  fi
                  echo "" >> schema_report_full.txt
                fi
              done
              
              echo "  Result: $SCENE_GROUP_PASSED/$SCENE_GROUP_TOTAL groups passed" >> schema_report.txt
              echo "" >> schema_report.txt
            fi
          done
          
          echo "============================================================" >> schema_report.txt
          echo "SCHEMA VALIDATION SUMMARY: $SCHEMA_PASSED/$SCHEMA_TOTAL files passed" >> schema_report.txt
          echo "============================================================" >> schema_report.txt

      - name: Generate field comparison report
        if: always()
        shell: bash
        run: |
          echo "# Field-Level Comparison Analysis Report" > field_compare_report.md
          echo "" >> field_compare_report.md
          echo "**Generated**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> field_compare_report.md
          echo "" >> field_compare_report.md
          
          echo "## Comparison Strategy" >> field_compare_report.md
          echo "" >> field_compare_report.md
          echo "### Strong Comparison (rtol=1e-6)" >> field_compare_report.md
          echo "Applied to critical scenes requiring high numerical precision:" >> field_compare_report.md
          echo "- scene_cli_complex vs scene_complex" >> field_compare_report.md
          echo "- scene_cli_sample vs scene_sample" >> field_compare_report.md
          echo "" >> field_compare_report.md
          echo "### Loose Comparison (rtol=1e-3)" >> field_compare_report.md
          echo "Applied to standard scenes with moderate precision requirements:" >> field_compare_report.md
          echo "- scene_holes, scene_multi_groups, scene_units" >> field_compare_report.md
          echo "" >> field_compare_report.md
          
          echo "## Detailed Comparison Results" >> field_compare_report.md
          echo "" >> field_compare_report.md
          
          # Include JSON comparison reports if they exist
          for JSON_REPORT in comparison_*.json; do
            if [ -f "$JSON_REPORT" ]; then
              SCENE_NAME=$(basename "$JSON_REPORT" .json | sed 's/comparison_//')
              echo "### $SCENE_NAME" >> field_compare_report.md
              echo '```json' >> field_compare_report.md
              cat "$JSON_REPORT" >> field_compare_report.md
              echo '```' >> field_compare_report.md
              echo "" >> field_compare_report.md
            fi
          done

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report-exports-validation
          path: test_report.md

      - name: Upload schema validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-report-exports-validation
          path: |
            schema_report.txt
            schema_report_full.txt

      - name: Upload field comparison report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: field-compare-report-exports-validation
          path: |
            field_compare_report.md
            comparison_*.json
            consistency_stats.txt

      - name: Generate vcpkg cache statistics
        if: always()
        shell: bash
        run: |
          echo "Generating vcpkg cache statistics..."
          # Generate stats from cmake logs
          if [ -f "build/_cmake_configure.log" ] || [ -f "build/_cmake_build.log" ]; then
            bash scripts/vcpkg_log_stats.sh \
              --logs build/_cmake_configure.log build/_cmake_build.log \
              --out-json build/vcpkg_cache_stats.json \
              --out-md build/vcpkg_cache_stats.md || echo '{"error": "Failed to generate stats"}' > build/vcpkg_cache_stats.json
          else
            echo '{"cacheable": false, "hit_rate": 0, "total": 0}' > build/vcpkg_cache_stats.json
          fi

          # Also generate vcpkg archives listing
          if [ -d "$HOME/.cache/vcpkg/archives" ]; then
            {
              echo "# vcpkg archives listing";
              echo "OS: Linux";
              echo "Dir: $HOME/.cache/vcpkg/archives";
              echo;
              echo "== Summary ==";
              du -sh "$HOME/.cache/vcpkg/archives" 2>/dev/null || echo "N/A";
              echo "files:" $(find "$HOME/.cache/vcpkg/archives" -type f | wc -l | tr -d ' ');
              echo;
              echo "== Top level ==";
              ls -lah "$HOME/.cache/vcpkg/archives" || echo "Directory not accessible";
            } > build/vcpkg_archives_listing.txt
          else
            echo "vcpkg archives directory not found" > build/vcpkg_archives_listing.txt
          fi

      - name: Upload strict exports reports (for Daily CI)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strict-exports-reports-ubuntu-latest
          path: |
            build/_cmake_configure.log
            build/_cmake_build.log
            build/vcpkg_cache_stats.json
            build/vcpkg_cache_stats.md
            build/vcpkg_archives_listing.txt
            test_report.md
            field_*.json
            consistency_stats.txt

      - name: Upload exports bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strict-exports-bundle-${{ github.run_id }}
          path: |
            build/exports/**
            build/export_cli_path.txt

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-exports-validation
          path: |
            build/CMakeFiles/CMakeOutput.log
            build/CMakeFiles/CMakeError.log
