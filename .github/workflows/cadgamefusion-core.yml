name: Core CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build Core (no Qt)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check project structure
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== Directory contents ==="
          ls -la
          echo "=== CMakeLists.txt exists? ==="
          test -f CMakeLists.txt && echo "Yes" || echo "No"
          echo "=== Core directory ==="
          ls -la core/ || echo "core/ not found"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Configure
        run: |
          echo "=== Running CMake configure ==="
          cmake --version
          echo "=== Attempting CMake configuration ==="
          cmake -S . -B build -DBUILD_EDITOR_QT=OFF -DCMAKE_BUILD_TYPE=Release 2>&1 | tee cmake_output.log || {
            echo "=== CMake failed with exit code $? ==="
            echo "=== CMake output log ==="
            cat cmake_output.log
            echo "=== CMakeError.log ==="
            cat build/CMakeFiles/CMakeError.log 2>/dev/null || echo "No CMakeError.log"
            echo "=== CMakeCache.txt ==="
            head -50 build/CMakeCache.txt 2>/dev/null || echo "No CMakeCache.txt"
            exit 1
          }

      - name: Build
        run: |
          echo "=== Starting build ==="
          cmake --build build --config Release --parallel 2 2>&1 | tee build_output.log || {
            echo "=== Build failed with exit code $? ==="
            echo "=== Last 100 lines of build output ==="
            tail -100 build_output.log
            echo "=== Finding error messages ==="
            grep -i "error" build_output.log | head -20 || true
            exit 1
          }

      - name: List build outputs
        run: |
          echo "-- build/bin --" && ls -la build/bin || true
          echo "-- build tree --" && find build -maxdepth 2 -type f | sed -n '1,200p' || true

      - name: Run core tests
        run: |
          echo "=== Running triangulation test ==="
          ./build/bin/core_tests_triangulation || echo "Triangulation test not found or failed"
          echo "=== Running boolean/offset test ==="
          ./build/bin/core_tests_boolean_offset || echo "Boolean/offset test not found or failed (expected without Clipper2)"

      - name: Show CMake logs
        if: always()
        run: |
          echo "---- CMake configure log ----"
          test -f build/CMakeFiles/CMakeConfigureLog.yaml && sed -n '1,400p' build/CMakeFiles/CMakeConfigureLog.yaml || echo "(no configure log)"
          echo "---- CMake feature status ----"
          grep -E "(USE_EARCUT|USE_CLIPPER2|Found|NOT FOUND)" build/CMakeFiles/CMakeOutput.log 2>/dev/null || echo "(features not logged)"

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ runner.os }}
          path: |
            build/CMakeFiles/CMakeConfigureLog.yaml
            build/bin/**
          if-no-files-found: warn

      - name: Upload C API library artifact
        uses: actions/upload-artifact@v4
        with:
          name: core_c-${{ runner.os }}
          path: |
            build/bin/core_c.dll
            build/bin/libcore_c.so
            build/bin/libcore_c.dylib
          if-no-files-found: ignore
