name: Solver From Project (Trial)

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
    paths:
      - 'tools/solve_from_project.cpp'
      - 'tools/CMakeLists.txt'
      - 'schemas/project.schema.json'
      - 'samples/**'

jobs:
  solver-project:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/vcpkg/archives
            vcpkg/installed
            vcpkg_installed
            build/vcpkg_installed
          key: ubuntu-vcpkg-solver-project-${{ hashFiles('**/vcpkg.json', 'vcpkg-configuration.json') }}-${{ github.run_number }}
          restore-keys: |
            ubuntu-vcpkg-solver-project-${{ hashFiles('**/vcpkg.json', 'vcpkg-configuration.json') }}-
            ubuntu-vcpkg-solver-project-

      - name: Setup vcpkg
        shell: bash
        run: |
          export VCPKG_DEFAULT_BINARY_CACHE="$HOME/.cache/vcpkg/archives"
          mkdir -p "$VCPKG_DEFAULT_BINARY_CACHE"
          echo "VCPKG_DEFAULT_BINARY_CACHE=$VCPKG_DEFAULT_BINARY_CACHE" >> $GITHUB_ENV
          echo "VCPKG_BINARY_SOURCES=clear;files,$VCPKG_DEFAULT_BINARY_CACHE,readwrite" >> $GITHUB_ENV

          if [ ! -d "vcpkg/.git" ]; then
            [ -d "vcpkg" ] && rm -rf vcpkg
            git clone https://github.com/microsoft/vcpkg.git vcpkg
          fi
          (cd vcpkg && git fetch --tags --force && git checkout a20d95d3c76906363896754eb1cc93db2a694f16 && ./bootstrap-vcpkg.sh)
          echo "VCPKG_ROOT=$(pwd)/vcpkg" >> $GITHUB_ENV

      - name: Validate sample project against schema
        run: |
          python tools/validate_project.py samples/project_minimal.json --schema schemas/project.schema.json
      - name: Configure & Build demo
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_EDITOR_QT=OFF \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            -G Ninja
          cmake --build build --config Release --target solve_from_project --parallel 2
      - name: Run solver from project
        run: |
          if [ -f build/tools/solve_from_project ]; then DEMO=build/tools/solve_from_project; else DEMO=build/solve_from_project; fi
          [ -f "$DEMO" ] || { echo "solve_from_project not found"; exit 1; }
          "$DEMO" samples/project_minimal.json
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: solver-project-trial-logs
          path: |
            build/CMakeFiles/CMakeConfigureLog.yaml
            build/**/CMakeError.log
            build/**/CMakeOutput.log
