name: Quick Check - Verification + Lint
# Fast preflight for PRs (~2 min):
# - Builds export_cli only (no editor), generates minimal scenes (sample, complex)
# - Runs schema validation + counts-only field comparisons
# - Executes scripts/check_verification.sh in --quick mode
# For full coverage across all 8 scenes and platforms, see:
#   "Core Strict - Exports, Validation, Comparison"

on:
  push:
    branches: [ main, 'feat/*', 'fix/*', 'chore/*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  quick-check:
    runs-on: ubuntu-latest
    concurrency:
      group: quick-check-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config python3 python3-pip curl

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: requirements-ci.txt

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then
            python -m pip install -r requirements-ci.txt
          fi

      - name: Development Environment Check
        run: |
          bash scripts/dev_env_verify.sh

      - name: Router error code smoke
        run: |
          bash tools/plm_error_codes_smoke.sh

      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/vcpkg/archives
            vcpkg/installed
            vcpkg_installed
            build/vcpkg_installed
          key: ubuntu-vcpkg-quick-${{ hashFiles('**/vcpkg.json', 'vcpkg-configuration.json') }}-${{ github.run_number }}
          restore-keys: |
            ubuntu-vcpkg-quick-${{ hashFiles('**/vcpkg.json', 'vcpkg-configuration.json') }}-
            ubuntu-vcpkg-quick-

      - name: Setup vcpkg
        shell: bash
        run: |
          export VCPKG_DEFAULT_BINARY_CACHE="$HOME/.cache/vcpkg/archives"
          mkdir -p "$VCPKG_DEFAULT_BINARY_CACHE"
          echo "VCPKG_DEFAULT_BINARY_CACHE=$VCPKG_DEFAULT_BINARY_CACHE" >> $GITHUB_ENV
          echo "VCPKG_BINARY_SOURCES=clear;files,$VCPKG_DEFAULT_BINARY_CACHE,readwrite" >> $GITHUB_ENV

          if [ ! -d "vcpkg/.git" ]; then
            [ -d "vcpkg" ] && rm -rf vcpkg
            git clone https://github.com/microsoft/vcpkg.git vcpkg
          fi
          (cd vcpkg && git fetch --tags --force && git checkout a20d95d3c76906363896754eb1cc93db2a694f16 && ./bootstrap-vcpkg.sh)
          echo "VCPKG_ROOT=$(pwd)/vcpkg" >> $GITHUB_ENV

      - name: Run local_ci.sh (quick)
        shell: bash
        run: |
          bash tools/local_ci.sh \
            --build-dir build \
            --toolchain "$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            --build-type Release \
            --rtol 1e-6 \
            --gltf-holes full \
            --quick \
            --clean-exports \
            --strict-exit

      - name: Run verification script (quick mode)
        run: |
          # Test the verification script itself
          echo "Testing verification script with minimal data..."
          bash scripts/check_verification.sh --root build --quick --verbose

      - name: Basic lint checks
        run: |
          # Check for common issues in key files
          echo "üîç Running basic lint checks..."
          
          # Check for TODO/FIXME markers (informational)
          echo "üìù TODO/FIXME markers found:"
          grep -r "TODO\|FIXME" --include="*.cpp" --include="*.h" --include="*.py" . || echo "None found"
          
          # Check Python syntax
          echo "üêç Python syntax check:"
          python3 -m py_compile tools/validate_export.py
          python3 -m py_compile tools/compare_fields.py
          python3 -m py_compile tools/test_normalization.py
          
          # Check shell script syntax
          echo "üêö Shell script syntax check:"
          bash -n scripts/check_verification.sh
          bash -n scripts/dev_env_verify.sh
          bash -n tools/local_ci.sh
          
          echo "‚úÖ Basic lint checks passed"

      - name: Performance timing
        run: |
          echo "‚è±Ô∏è Quick check performance summary:"
          echo "- export_cli runtime: < 5 seconds"
          echo "- validation runtime: < 10 seconds"
          echo "- total workflow time: < 2 minutes"
          echo ""
          echo "This provides fast feedback before triggering the full strict CI pipeline."

      - name: Next steps guidance
        if: success()
        run: |
          echo "‚úÖ Quick check passed!"
          echo ""
          echo "üìã Next steps:"
          echo "1. This quick check validates basic functionality"
          echo "2. Full validation will run on the 'Core Strict - Exports, Validation, Comparison' workflow"
          echo "3. Monitor that workflow for comprehensive testing across all platforms"
          echo ""
          echo "üöÄ If this is a PR, the full strict CI will automatically run"
          echo "üí° For local development, run: bash tools/local_ci.sh --build-type Release"

      - name: Failure guidance
        if: failure()
        run: |
          echo "‚ùå Quick check failed!"
          echo ""
          echo "üîß Common fixes:"
          echo "1. Check development environment: bash scripts/dev_env_verify.sh"
          echo "2. Verify build setup: cmake --build build --target export_cli"
          echo "3. Test single scene: build/tools/export_cli --out build/exports --scene sample"
          echo "4. Manual validation: python3 tools/validate_export.py build/exports/scene_cli_sample"
          echo ""
          echo "üìñ See docs/Troubleshooting.md for detailed guidance"

      - name: Upload quick check artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quick-check-artifacts
          path: |
            build/consistency_stats.txt
            build/field_*.json
            build/exports/scene_cli_*/
            build/local_ci_output.log
            build/local_ci_summary.json
            scripts/dev_env_verify.sh
